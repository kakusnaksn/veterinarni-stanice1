<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezervace - Veterinární ordinace</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; }
        .hlavicka { display: flex; justify-content: space-between; align-items: center; padding: 20px; background-color: #4CAF50; color: white; }
        .hlavicka h1 { margin: 0; }
        .hlavicka-buttons { display: flex; gap: 10px; }
        .prihlaseni-btn { padding: 10px 20px; width: 160px; background-color: #ffffff; color: #4CAF50; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; text-align: center; }
        .prihlaseni-btn:hover { background-color: #e0e0e0; }
        .sekce { max-width: 1000px; margin: 20px auto; padding: 20px; background-color: white; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .datum { text-align: center; font-size: 1.2em; margin-bottom: 20px; }
        .vyber-datum { text-align: center; margin-bottom: 20px; }
        .vyber-datum input[type="date"] { padding: 10px; font-size: 1em; border: 1px solid #ddd; border-radius: 5px; width: 360px; height: 40px; }
        .mesic-kalendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-bottom: 20px; }
        .den { padding: 10px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .den.volny { background-color: #4CAF50; color: white; }
        .den.obsazeny { background-color: #f44336; color: white; }
        .den:hover:not(.obsazeny) { background-color: #45a049; }
        .terminy { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 20px; }
        .termin { padding: 15px; text-align: center; border-radius: 5px; cursor: pointer; }
        .volny { background-color: #4CAF50; color: white; }
        .obsazeny { background-color: #f44336; color: white; }
        .cekajici { background-color: #ff9800; color: white; }
        .volny:hover { background-color: #45a049; }
        .obsazeny:hover { background-color: #d32f2f; }
        .cekajici:hover { background-color: #e68a00; }
        .podrobnosti { font-size: 0.9em; margin-top: 5px; }
        .mesic-ovladani { text-align: center; margin-bottom: 10px; }
        .mesic-ovladani button { padding: 8px 16px; margin: 0 5px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .mesic-ovladani button:hover { background-color: #45a049; }
        .formular { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.3); width: 400px; }
        .formular h3 { margin: 0 0 20px 0; text-align: center; }
        .formular .zavrit { position: absolute; right: 10px; top: 5px; font-size: 20px; cursor: pointer; color: #f44336; }
        .formular input, .formular select, .formular textarea { display: block; width: 360px; height: 40px; margin: 10px auto; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .formular textarea { height: 80px; }
        .formular button { display: block; width: 360px; height: 40px; margin: 10px auto; padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .formular .smazat-btn { background-color: #f44336; }
        .formular .schvalit-btn { background-color: #2196F3; }
        .formular button:hover { background-color: #45a049; }
        .formular .smazat-btn:hover { background-color: #d32f2f; }
        .formular .schvalit-btn:hover { background-color: #1976D2; }
        .hidden { display: none; }
        .search-bar { margin: 20px 0; text-align: center; }
        .search-bar input { width: 360px; height: 40px; padding: 10px; }
        .user-list, .notes-list, .reservations-list { margin-top: 20px; }
        .user-item, .note-item, .reservation-item { padding: 10px; border-bottom: 1px solid #ddd; }
        .pet-list { margin-top: 10px; }
        .pet-item { padding: 5px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="hlavicka">
        <h1>Veterinární ordinace - Rezervace</h1>
        <div class="hlavicka-buttons">
            <button class="prihlaseni-btn" onclick="zobrazitPrihlaseni()">Přihlášení</button>
            <button class="prihlaseni-btn" onclick="zobrazitRegistraci()">Registrace</button>
            <button class="prihlaseni-btn hidden" id="pridat-mazlicka-btn" onclick="zobrazitPridaniMazlicka()">Přidat mazlíčka</button>
            <button class="prihlaseni-btn hidden" id="odhlaseni-btn" onclick="odhlasit()">Odhlásit</button>
        </div>
    </div>

    <div class="sekce" id="zakaznici-sekce">
        <div class="datum" id="datum-zakaznici"></div>
        <div class="vyber-datum">
            <input type="date" id="vyber-dne" onchange="zmenitDen(this.value)">
        </div>
        <div class="terminy" id="terminy-zakaznici"></div>
    </div>

    <div class="sekce hidden" id="admin-sekce">
        <div class="datum" id="datum-admin"></div>
        <div class="mesic-ovladani">
            <button onclick="predchoziMesic()">Předchozí měsíc</button>
            <button onclick="nasledujiciMesic()">Následující měsíc</button>
        </div>
        <div class="mesic-kalendar" id="mesic-kalendar-admin"></div>
        <div class="vyber-datum">
            <input type="date" id="vyber-dne-admin" onchange="zmenitDenAdmin(this.value)">
        </div>
        <div class="terminy" id="terminy-admin"></div>
        <div class="search-bar">
            <input type="text" id="search-users" placeholder="Hledat uživatele..." oninput="prohledatUzivatele()">
        </div>
        <div class="user-list" id="user-list"></div>
    </div>

    <div class="formular" id="prihlaseni-form">
        <h3>Přihlášení <span class="zavrit" onclick="zavritPrihlaseni()">×</span></h3>
        <input type="text" id="jmeno" placeholder="Uživatelské jméno">
        <input type="password" id="heslo" placeholder="Heslo">
        <button onclick="prihlasit()">Přihlásit se</button>
    </div>

    <div class="formular" id="registrace-form">
        <h3>Registrace <span class="zavrit" onclick="zavritRegistraci()">×</span></h3>
        <input type="text" id="reg-jmeno" placeholder="Uživatelské jméno" required>
        <input type="email" id="reg-email" placeholder="E-mail" required>
        <input type="text" id="reg-telefon" placeholder="Telefon" required>
        <input type="password" id="reg-heslo" placeholder="Heslo" required>
        <button onclick="registrovat()">Registrovat se</button>
    </div>

    <div class="formular" id="rezervace-form">
        <h3>Nová rezervace <span class="zavrit" onclick="zavritRezervaci()">×</span></h3>
        <select id="zakaznik-select" onchange="vyplnitUdajeZakaznika()" class="hidden">
            <option value="">Vyberte zákazníka</option>
            <option value="novy">Nový zákazník</option>
        </select>
        <input type="text" id="zakaznik" placeholder="Jméno zákazníka" required>
        <select id="zvire" class="zvire-select"></select>
        <input type="text" id="duvod" placeholder="Důvod návštěvy" required>
        <input type="text" id="telefon" placeholder="Telefon (volitelné)">
        <input type="email" id="email" placeholder="E-mail (volitelné)">
        <textarea id="poznamka" placeholder="Poznámka k rezervaci"></textarea>
        <button onclick="ulozitRezervaci()">Uložit</button>
    </div>

    <div class="formular" id="editace-form">
        <h3>Upravit rezervaci <span class="zavrit" onclick="zavritEditaci()">×</span></h3>
        <input type="text" id="edit-zakaznik" placeholder="Jméno zákazníka" required>
        <select id="edit-zvire" class="zvire-select"></select>
        <input type="text" id="edit-duvod" placeholder="Důvod návštěvy" required>
        <input type="text" id="edit-telefon" placeholder="Telefon (volitelné)">
        <input type="email" id="edit-email" placeholder="E-mail (volitelné)">
        <select id="edit-cas-zacatek" required>
            <option value="8:00">8:00</option><option value="8:30">8:30</option><option value="9:00">9:00</option>
            <option value="9:30">9:30</option><option value="10:00">10:00</option><option value="10:30">10:30</option>
            <option value="11:00">11:00</option><option value="11:30">11:30</option><option value="13:00">13:00</option>
            <option value="13:30">13:30</option><option value="14:00">14:00</option><option value="14:30">14:30</option>
            <option value="15:00">15:00</option><option value="15:30">15:30</option>
        </select>
        <select id="edit-cas-konec">
            <option value="">Žádný konec</option>
            <option value="8:30">8:30</option><option value="9:00">9:00</option><option value="9:30">9:30</option>
            <option value="10:00">10:00</option><option value="10:30">10:30</option><option value="11:00">11:00</option>
            <option value="11:30">11:30</option><option value="13:00">13:00</option><option value="13:30">13:30</option>
            <option value="14:00">14:00</option><option value="14:30">14:30</option><option value="15:00">15:00</option>
            <option value="15:30">15:30</option><option value="16:00">16:00</option>
        </select>
        <textarea id="edit-poznamka" placeholder="Poznámka k rezervaci"></textarea>
        <button onclick="ulozitEditaci()">Uložit změny</button>
        <button class="smazat-btn" onclick="smazatRezervaci()">Smazat rezervaci</button>
        <button class="schvalit-btn hidden" id="schvalit-btn" onclick="schvalitRezervaci()">Schválit rezervaci</button>
    </div>

    <div class="formular" id="pridani-mazlicka-form">
        <h3>Přidat mazlíčka <span class="zavrit" onclick="zavritPridaniMazlicka()">×</span></h3>
        <input type="text" id="novy-mazlicek" placeholder="Jméno mazlíčka" required>
        <select id="druh-zvirete" onchange="zobrazitJine()" required>
            <option value="">Vyberte druh</option>
            <option value="Pes">Pes</option>
            <option value="Kočka">Kočka</option>
            <option value="Králík">Králík</option>
            <option value="Morče">Morče</option>
            <option value="Jiné">Jiné</option>
        </select>
        <input type="text" id="jine-zvire" placeholder="Zadejte druh" class="hidden">
        <button onclick="pridatMazlicka()">Přidat</button>
    </div>

    <div class="formular" id="edit-user-form">
        <h3>Upravit uživatele <span class="zavrit" onclick="zavritEditUser()">×</span></h3>
        <input type="text" id="edit-user-jmeno" placeholder="Jméno" disabled>
        <input type="email" id="edit-user-email" placeholder="E-mail" disabled>
        <input type="text" id="edit-user-telefon" placeholder="Telefon" disabled>
        <input type="password" id="edit-user-heslo" placeholder="Nové heslo">
        <div class="notes-list" id="edit-user-notes"></div>
        <textarea id="edit-user-poznamka" placeholder="Nová poznámka"></textarea>
        <button onclick="pridatPoznamkuAdmin()">Přidat poznámku</button>
        <button onclick="ulozitHeslo()">Změnit heslo</button>
        <div class="reservations-list" id="edit-user-reservations"></div>
    </div>

    <script>
        let vybranyDen = new Date();
        let jePrihlasen = false;
        let jeAdmin = false;
        let token = null;
        let userId = null;
        let userPets = [];
        const casy = ["8:00", "8:30", "9:00", "9:30", "10:00", "10:30", "11:00", "11:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30"];

        async function fetchReservations(date) {
            const response = await fetch(`/reservations/${date}`, {
                headers: jePrihlasen ? { 'Authorization': `Bearer ${token}` } : {}
            });
            return await response.json();
        }

        async function fetchUserData() {
            const response = await fetch('/profile', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            userPets = data.pets || [];
            return data;
        }

        async function fetchUsers(search = '') {
            const response = await fetch(`/users?search=${search}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            return await response.json();
        }

        async function fetchUserReservations(userId) {
            const response = await fetch(`/users/${userId}/reservations`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            return await response.json();
        }

        async function aktualizovatZakaznici() {
            const datumZakaznici = document.getElementById('datum-zakaznici');
            const vyberDne = document.getElementById('vyber-dne');
            vyberDne.value = vybranyDen.toISOString().split('T')[0];
            datumZakaznici.textContent = `Rezervace na ${vybranyDen.toLocaleDateString('cs-CZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            await aktualizovatTerminy('terminy-zakaznici', false);
        }

        async function aktualizovatAdmin() {
            const datumAdmin = document.getElementById('datum-admin');
            const vyberDneAdmin = document.getElementById('vyber-dne-admin');
            vyberDneAdmin.value = vybranyDen.toISOString().split('T')[0];
            datumAdmin.textContent = `Správa rezervací na ${vybranyDen.toLocaleDateString('cs-CZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            await aktualizovatMesicKalendar();
            await aktualizovatTerminy('terminy-admin', true);
            await prohledatUzivatele();
        }

        async function aktualizovatMesicKalendar() {
            const kalendar = document.getElementById('mesic-kalendar-admin');
            kalendar.innerHTML = '';
            const prvniDen = new Date(vybranyDen.getFullYear(), vybranyDen.getMonth(), 1);
            const posledniDen = new Date(vybranyDen.getFullYear(), vybranyDen.getMonth() + 1, 0);
            const startDen = prvniDen.getDay() || 7;

            for (let i = 1; i < startDen; i++) {
                const div = document.createElement('div');
                div.classList.add('den');
                kalendar.appendChild(div);
            }

            for (let i = 1; i <= posledniDen.getDate(); i++) {
                const den = new Date(vybranyDen.getFullYear(), vybranyDen.getMonth(), i);
                const denKey = den.toISOString().split('T')[0];
                const reservations = await fetchReservations(denKey);
                const div = document.createElement('div');
                div.classList.add('den');
                div.textContent = i;
                const maVolne = casy.some(cas => !reservations.some(r => r.time === cas && r.approved));
                div.classList.add(maVolne ? 'volny' : 'obsazeny');
                div.addEventListener('click', () => {
                    vybranyDen = den;
                    aktualizovatAdmin();
                });
                kalendar.appendChild(div);
            }
        }

        async function aktualizovatTerminy(terminyId, editMode) {
            const terminyList = document.getElementById(terminyId);
            terminyList.innerHTML = '';
            const denKey = vybranyDen.toISOString().split('T')[0];
            const reservations = await fetchReservations(denKey);

            casy.forEach(cas => {
                const reservation = reservations.find(r => r.time === cas);
                const div = document.createElement('div');
                div.classList.add('termin');
                div.dataset.id = reservation ? reservation.id : null;
                div.textContent = reservation ? `${reservation.time}${reservation.timeEnd ? ` - ${reservation.timeEnd}` : ''}` : cas;

                if (!reservation) {
                    div.classList.add('volny');
                } else if (!reservation.approved) {
                    div.classList.add('cekajici');
                } else {
                    div.classList.add('obsazeny');
                }

                if (reservation && (editMode || (jePrihlasen && reservation.userId === userId))) {
                    const podrobnosti = document.createElement('div');
                    podrobnosti.classList.add('podrobnosti');
                    let text = `${reservation.zakaznik} (${reservation.zvire || 'Bez zvířete'}) - ${reservation.duvod}`;
                    if (reservation.telefon) text += `\nTel: ${reservation.telefon}`;
                    if (reservation.email) text += `\nEmail: ${reservation.email}`;
                    if (reservation.note) text += `\nPoznámka: ${reservation.note}`;
                    if (!reservation.approved) text += `\n(Čeká na schválení)`;
                    podrobnosti.textContent = text;
                    div.appendChild(podrobnosti);
                }

                div.addEventListener('click', async () => {
                    if (!jePrihlasen) return alert("Musíte být přihlášeni k rezervaci nebo úpravě!");
                    if (editMode && reservation) {
                        vybranyTermin = reservation;
                        zobrazitEditaci();
                    } else if ((editMode || jePrihlasen) && !reservation) {
                        vybranyTermin = { date: denKey, time: cas };
                        zobrazitRezervaci();
                    }
                });

                terminyList.appendChild(div);
            });
        }

        async function prohledatUzivatele() {
            if (!jeAdmin) return;
            const search = document.getElementById('search-users').value;
            const users = await fetchUsers(search);
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            const zakaznikSelect = document.getElementById('zakaznik-select');
            zakaznikSelect.innerHTML = '<option value="">Vyberte zákazníka</option><option value="novy">Nový zákazník</option>';
            users.forEach(user => {
                const div = document.createElement('div');
                div.classList.add('user-item');
                div.innerHTML = `${user.username} (${user.email}) <button onclick="upravitUzivatele(${user.id})">Upravit</button>`;
                userList.appendChild(div);

                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.username} (${user.email})`;
                zakaznikSelect.appendChild(option);
            });
        }

        function predchoziMesic() {
            vybranyDen.setMonth(vybranyDen.getMonth() - 1);
            aktualizovatAdmin();
        }

        function nasledujiciMesic() {
            vybranyDen.setMonth(vybranyDen.getMonth() + 1);
            aktualizovatAdmin();
        }

        function zmenitDen(datum) {
            vybranyDen = new Date(datum);
            aktualizovatZakaznici();
        }

        function zmenitDenAdmin(datum) {
            vybranyDen = new Date(datum);
            aktualizovatAdmin();
        }

        function zobrazitPrihlaseni() {
            document.getElementById('prihlaseni-form').style.display = 'block';
        }

        function zavritPrihlaseni() {
            document.getElementById('prihlaseni-form').style.display = 'none';
        }

        function zobrazitRegistraci() {
            document.getElementById('registrace-form').style.display = 'block';
        }

        function zavritRegistraci() {
            document.getElementById('registrace-form').style.display = 'none';
        }

        async function prihlasit() {
            const jmeno = document.getElementById('jmeno').value;
            const heslo = document.getElementById('heslo').value;
            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ jmeno, heslo })
            });
            const result = await response.json();
            if (result.success) {
                token = result.token;
                jePrihlasen = true;
                userId = result.userId;
                jeAdmin = result.isAdmin;
                document.getElementById('prihlaseni-form').style.display = 'none';
                document.getElementById('odhlaseni-btn').classList.remove('hidden');
                if (!jeAdmin) document.getElementById('pridat-mazlicka-btn').classList.remove('hidden');
                if (jeAdmin) {
                    document.getElementById('zakaznici-sekce').classList.add('hidden');
                    document.getElementById('admin-sekce').classList.remove('hidden');
                    aktualizovatAdmin();
                } else {
                    aktualizovatZakaznici();
                }
            } else {
                alert("Špatné jméno nebo heslo!");
            }
        }

        async function registrovat() {
            const jmeno = document.getElementById('reg-jmeno').value;
            const email = document.getElementById('reg-email').value;
            const telefon = document.getElementById('reg-telefon').value;
            const heslo = document.getElementById('reg-heslo').value;
            if (jmeno && email && telefon && heslo) {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jmeno, email, telefon, heslo })
                });
                const result = await response.json();
                if (result.success) {
                    alert("Registrace úspěšná! Nyní se můžete přihlásit.");
                    zavritRegistraci();
                } else {
                    alert(result.message || "Registrace selhala.");
                }
            } else {
                alert("Vyplňte všechna pole!");
            }
        }

        function odhlasit() {
            jePrihlasen = false;
            jeAdmin = false;
            token = null;
            userId = null;
            userPets = [];
            document.getElementById('zakaznici-sekce').classList.remove('hidden');
            document.getElementById('admin-sekce').classList.add('hidden');
            document.getElementById('pridat-mazlicka-btn').classList.add('hidden');
            document.getElementById('odhlaseni-btn').classList.add('hidden');
            aktualizovatZakaznici();
        }

        async function zobrazitRezervaci() {
            if (!jePrihlasen) return alert("Musíte být přihlášeni!");
            const userData = await fetchUserData();
            document.getElementById('rezervace-form').style.display = 'block';
            const zakaznikInput = document.getElementById('zakaznik');
            const zakaznikSelect = document.getElementById('zakaznik-select');

            if (jeAdmin) {
                zakaznikSelect.classList.remove('hidden');
                zakaznikInput.disabled = false;
                zakaznikInput.value = '';
                document.getElementById('zvire').removeAttribute('required');
            } else {
                zakaznikSelect.classList.add('hidden');
                zakaznikInput.value = userData.username;
                zakaznikInput.disabled = true;
                document.getElementById('telefon').value = userData.telefon;
                document.getElementById('email').value = userData.email;
                document.getElementById('zvire').setAttribute('required', '');
            }

            const zvireSelect = document.getElementById('zvire');
            zvireSelect.innerHTML = '<option value="">Vyberte mazlíčka</option>';
            userPets.forEach(pet => {
                const option = document.createElement('option');
                option.value = pet.name;
                option.textContent = `${pet.name} (${pet.species})`;
                zvireSelect.appendChild(option);
            });
        }

        async function vyplnitUdajeZakaznika() {
            if (!jeAdmin) return;
            const zakaznikSelect = document.getElementById('zakaznik-select').value;
            const zakaznikInput = document.getElementById('zakaznik');
            const telefonInput = document.getElementById('telefon');
            const emailInput = document.getElementById('email');
            const zvireSelect = document.getElementById('zvire');

            if (zakaznikSelect === 'novy') {
                zakaznikInput.value = '';
                telefonInput.value = '';
                emailInput.value = '';
                zvireSelect.innerHTML = '<option value="">Bez zvířete</option>';
            } else if (zakaznikSelect) {
                const response = await fetch(`/users/${zakaznikSelect}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await response.json();
                zakaznikInput.value = user.username;
                telefonInput.value = user.telefon;
                emailInput.value = user.email;
                zvireSelect.innerHTML = '<option value="">Bez zvířete</option>';
                user.pets.forEach(pet => {
                    const option = document.createElement('option');
                    option.value = pet.name;
                    option.textContent = `${pet.name} (${pet.species})`;
                    zvireSelect.appendChild(option);
                });
            }
        }

        function zavritRezervaci() {
            document.getElementById('rezervace-form').style.display = 'none';
        }

        async function ulozitRezervaci() {
            const zakaznikSelect = jeAdmin ? document.getElementById('zakaznik-select').value : null;
            const zakaznik = document.getElementById('zakaznik').value;
            const zvire = document.getElementById('zvire').value || null;
            const duvod = document.getElementById('duvod').value;
            const telefon = document.getElementById('telefon').value;
            const email = document.getElementById('email').value;
            const note = document.getElementById('poznamka').value;

            if (zakaznik && duvod && (jeAdmin || zvire)) {
                const reservation = {
                    date: vybranyTermin.date,
                    time: vybranyTermin.time,
                    zakaznik,
                    zvire,
                    duvod,
                    telefon,
                    email,
                    note,
                    userId: jeAdmin && zakaznikSelect !== 'novy' ? zakaznikSelect : userId
                };
                const response = await fetch('/reservations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(reservation)
                });
                const result = await response.json();
                if (response.ok) {
                    document.getElementById('rezervace-form').style.display = 'none';
                    if (!jeAdmin) alert("Rezervace uložena. Vyčkejte na schválení.");
                    if (jeAdmin) aktualizovatAdmin();
                    else aktualizovatZakaznici();
                } else {
                    alert(result.error || "Nepodařilo se uložit rezervaci.");
                }
            } else {
                alert("Vyplňte povinné údaje!");
            }
        }

        async function zobrazitEditaci() {
            if (!jePrihlasen) return alert("Musíte být přihlášeni!");
            if (!jeAdmin && vybranyTermin.userId !== userId) return alert("Můžete upravit pouze své rezervace!");
            const userData = await fetchUserData();
            document.getElementById('editace-form').style.display = 'block';
            document.getElementById('edit-zakaznik').value = vybranyTermin.zakaznik;
            const zvireSelect = document.getElementById('edit-zvire');
            zvireSelect.innerHTML = '<option value="">Vyberte mazlíčka</option>';
            userPets.forEach(pet => {
                const option = document.createElement('option');
                option.value = pet.name;
                option.textContent = `${pet.name} (${pet.species})`;
                option.selected = pet.name === vybranyTermin.zvire;
                zvireSelect.appendChild(option);
            });
            if (!jeAdmin) zvireSelect.setAttribute('required', '');
            document.getElementById('edit-duvod').value = vybranyTermin.duvod;
            document.getElementById('edit-telefon').value = vybranyTermin.telefon || '';
            document.getElementById('edit-email').value = vybranyTermin.email || '';
            document.getElementById('edit-cas-zacatek').value = vybranyTermin.time;
            document.getElementById('edit-cas-konec').value = vybranyTermin.timeEnd || '';
            document.getElementById('edit-poznamka').value = vybranyTermin.note || '';
            document.getElementById('schvalit-btn').classList.toggle('hidden', vybranyTermin.approved || !jeAdmin);
        }

        function zavritEditaci() {
            document.getElementById('editace-form').style.display = 'none';
        }

        async function ulozitEditaci() {
            const zakaznik = document.getElementById('edit-zakaznik').value;
            const zvire = document.getElementById('edit-zvire').value || null;
            const duvod = document.getElementById('edit-duvod').value;
            const telefon = document.getElementById('edit-telefon').value;
            const email = document.getElementById('edit-email').value;
            const time = document.getElementById('edit-cas-zacatek').value;
            const timeEnd = document.getElementById('edit-cas-konec').value;
            const note = document.getElementById('edit-poznamka').value;

            if (zakaznik && duvod && (jeAdmin || zvire)) {
                const reservation = {
                    time,
                    timeEnd: timeEnd || null,
                    zakaznik,
                    zvire,
                    duvod,
                    telefon,
                    email,
                    note
                };
                const response = await fetch(`/reservations/${vybranyTermin.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(reservation)
                });
                if (response.ok) {
                    document.getElementById('editace-form').style.display = 'none';
                    if (jeAdmin) aktualizovatAdmin();
                    else aktualizovatZakaznici();
                } else {
                    alert("Nepodařilo se uložit změny.");
                }
            } else {
                alert("Vyplňte povinné údaje!");
            }
        }

        async function smazatRezervaci() {
            if (!jeAdmin && vybranyTermin.userId !== userId) return alert("Můžete smazat pouze své rezervace!");
            const potvrzeni = confirm(`Opravdu chcete smazat rezervaci pro ${vybranyTermin.zakaznik}?`);
            if (potvrzeni) {
                const response = await fetch(`/reservations/${vybranyTermin.id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    document.getElementById('editace-form').style.display = 'none';
                    if (jeAdmin) aktualizovatAdmin();
                    else aktualizovatZakaznici();
                } else {
                    alert('Nepodařilo se smazat rezervaci.');
                }
            }
        }

        async function schvalitRezervaci() {
            if (!jeAdmin) return alert("Pouze admin může schvalovat rezervace!");
            const response = await fetch(`/reservations/${vybranyTermin.id}/approve`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                document.getElementById('editace-form').style.display = 'none';
                aktualizovatAdmin();
            } else {
                alert('Nepodařilo se schválit rezervaci.');
            }
        }

        function zobrazitPridaniMazlicka() {
            if (jeAdmin) return; // Admin nemá tuto možnost
            document.getElementById('pridani-mazlicka-form').style.display = 'block';
            document.getElementById('jine-zvire').classList.add('hidden');
        }

        function zavritPridaniMazlicka() {
            document.getElementById('pridani-mazlicka-form').style.display = 'none';
        }

        function zobrazitJine() {
            const druh = document.getElementById('druh-zvirete').value;
            const jineZvire = document.getElementById('jine-zvire');
            jineZvire.classList.toggle('hidden', druh !== 'Jiné');
            jineZvire.required = druh === 'Jiné';
        }

        async function pridatMazlicka() {
            if (jeAdmin) return; // Admin nemá tuto možnost
            const jmeno = document.getElementById('novy-mazlicek').value;
            let druh = document.getElementById('druh-zvirete').value;
            const jineZvire = document.getElementById('jine-zvire').value;

            if (jmeno && druh) {
                if (druh === 'Jiné' && !jineZvire) {
                    return alert("Zadejte druh zvířete!");
                }
                if (druh === 'Jiné') druh = jineZvire;
                const pet = { name: jmeno, species: druh };
                const response = await fetch('/profile/pets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(pet)
                });
                if (response.ok) {
                    userPets.push(pet);
                    document.getElementById('novy-mazlicek').value = '';
                    document.getElementById('druh-zvirete').value = '';
                    document.getElementById('jine-zvire').value = '';
                    document.getElementById('jine-zvire').classList.add('hidden');
                    zavritPridaniMazlicka();
                } else {
                    alert("Nepodařilo se přidat mazlíčka.");
                }
            } else {
                alert("Vyplňte jméno a druh mazlíčka!");
            }
        }

        let vybranyUzivatel = null;
        async function upravitUzivatele(id) {
            vybranyUzivatel = id;
            const response = await fetch(`/users/${id}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const user = await response.json();
            document.getElementById('edit-user-form').style.display = 'block';
            document.getElementById('edit-user-jmeno').value = user.username;
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-telefon').value = user.telefon;
            document.getElementById('edit-user-heslo').value = '';
            const notesList = document.getElementById('edit-user-notes');
            notesList.innerHTML = '';
            user.notes.forEach(note => {
                const div = document.createElement('div');
                div.classList.add('note-item');
                div.textContent = `${note.author}: ${note.text}`;
                notesList.appendChild(div);
            });
            const reservationsList = document.getElementById('edit-user-reservations');
            reservationsList.innerHTML = '';
            const reservations = await fetchUserReservations(id);
            reservations.forEach(res => {
                const div = document.createElement('div');
                div.classList.add('reservation-item');
                div.textContent = `${res.date} ${res.time}${res.timeEnd ? ` - ${res.timeEnd}` : ''}: ${res.zvire || 'Bez zvířete'} - ${res.duvod}${res.approved ? '' : ' (Čeká na schválení)'}`;
                reservationsList.appendChild(div);
            });
        }

        function zavritEditUser() {
            document.getElementById('edit-user-form').style.display = 'none';
        }

        async function ulozitHeslo() {
            const heslo = document.getElementById('edit-user-heslo').value;
            if (heslo) {
                const response = await fetch(`/users/${vybranyUzivatel}/password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ password: heslo })
                });
                if (response.ok) {
                    alert("Heslo změněno.");
                    document.getElementById('edit-user-heslo').value = '';
                } else {
                    alert("Nepodařilo se změnit heslo.");
                }
            }
        }

        async function pridatPoznamkuAdmin() {
            const novaPoznamka = document.getElementById('edit-user-poznamka').value;
            if (novaPoznamka) {
                const response = await fetch(`/users/${vybranyUzivatel}/notes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ note: novaPoznamka })
                });
                if (response.ok) {
                    document.getElementById('edit-user-poznamka').value = '';
                    upravitUzivatele(vybranyUzivatel);
                } else {
                    alert("Nepodařilo se přidat poznámku.");
                }
            }
        }

        // Inicializace
        aktualizovatZakaznici();
    </script>
</body>
</html>
