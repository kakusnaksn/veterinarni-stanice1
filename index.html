<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezervační systém pro salóny</title>
    <!-- GSAP pro animace -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <!-- Three.js pro 3D efekty -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <!-- GLTFLoader pro načítání 3D modelů -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #F5F5DC; /* Béžové pozadí */
            color: #333; /* Tmavší barva textu pro čitelnost na béžovém pozadí */
            overflow-x: hidden; 
        }
        .hlavicka { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 20px; 
            background-color: #1F2937; /* Tmavší šedá (původní barva pozadí) */
            color: white; /* Bílý text v hlavičce */
            position: relative; 
        }
        .hlavicka h1 { margin: 0; margin-left: 100px; }
        .hlavicka-buttons { display: flex; gap: 10px; }
        #scissors-3d { 
            position: absolute; 
            left: 20px; 
            top: 20px; 
            width: 80px; 
            height: 80px; 
            z-index: 10; 
        }
        .prihlaseni-btn { 
            padding: 10px 20px; 
            width: 160px; 
            background-color: #ffffff; 
            color: #1E3A8A; /* Tmavě modrá barva textu */
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
            text-align: center; 
            transition: transform 0.3s ease, background-color 0.3s ease; 
        }
        .prihlaseni-btn:hover { 
            transform: scale(1.05); 
            background-color: #e0e0e0; 
        }
        .sekce { 
            max-width: 1000px; 
            margin: 20px auto; 
            padding: 20px; 
            background-color: #374151; /* Světlejší šedá pro sekce */
            border-radius: 5px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.3); 
            opacity: 0; /* Pro animaci fade-in */
            color: white; /* Bílý text v sekcích */
        }
        .datum { 
            text-align: center; 
            font-size: 1.2em; 
            margin-bottom: 20px; 
        }
        .vyber-datum { 
            text-align: center; 
            margin-bottom: 20px; 
        }
        .vyber-datum input[type="date"] { 
            padding: 10px; 
            font-size: 1em; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            width: 360px; 
            height: 40px; 
            background-color: #1F2937; 
            color: white; 
        }
        .mesic-kalendar { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 5px; 
            text-align: center; 
            margin-bottom: 20px; 
        }
        .den { 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            cursor: pointer; 
            transition: transform 0.3s ease; 
            background-color: #374151; 
        }
        .den.volny { 
            background-color: #1E3A8A; /* Tmavě modrá pro volné dny */
            color: white; 
        }
        .den.obsazeny { 
            background-color: #f44336; 
            color: white; 
        }
        .den:hover:not(.obsazeny) { 
            transform: translateY(-5px); /* 3D efekt vyskočení */
            background-color: #2B4A9B; /* Světlejší tmavě modrá při najetí */
        }
        .terminy { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 10px; 
            margin-top: 20px; 
        }
        .termin { 
            padding: 15px; 
            text-align: center; 
            border-radius: 5px; 
            cursor: pointer; 
            position: relative; 
            transform-style: preserve-3d; 
            transition: transform 0.3s ease; 
            background-color: #374151; 
        }
        .volny { 
            background-color: #1E3A8A; /* Tmavě modrá pro volné termíny */
            color: white; 
        }
        .obsazeny { 
            background-color: #f44336; 
            color: white; 
        }
        .cekajici { 
            background-color: #ff9800; 
            color: white; 
        }
        .smazany { 
            background-color: #9e9e9e; 
            color: white; 
        }
        .termin:hover { 
            transform: rotateY(10deg) rotateX(10deg); /* 3D otáčení při najetí */
        }
        .podrobnosti { 
            font-size: 0.9em; 
            margin-top: 5px; 
        }
        .mesic-ovladani { 
            text-align: center; 
            margin-bottom: 10px; 
        }
        .mesic-ovladani button { 
            padding: 8px 16px; 
            margin: 0 5px; 
            background-color: #1E3A8A; /* Tmavě modrá tlačítka */
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            transition: transform 0.3s ease; 
        }
        .mesic-ovladani button:hover { 
            transform: scale(1.05); 
            background-color: #2B4A9B; /* Světlejší tmavě modrá při najetí */
        }
        .formular { 
            display: none; 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background-color: #374151; /* Světlejší šedá pro formuláře */
            padding: 20px; 
            border-radius: 5px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.3); 
            width: 400px; 
            opacity: 0; /* Pro animaci */
            color: white; /* Bílý text ve formulářích */
        }
        .formular h3 { margin: 0 0 20px 0; text-align: center; color: white; }
        .formular .zavrit { 
            position: absolute; 
            right: 10px; 
            top: 5px; 
            font-size: 20px; 
            cursor: pointer; 
            color: #f44336; 
        }
        .formular input, .formular select, .formular textarea { 
            display: block; 
            width: 360px; 
            height: 40px; 
            margin: 10px auto; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            box-sizing: border-box; 
            background-color: #1F2937; 
            color: white; 
        }
        .formular textarea { height: 80px; }
        .formular button { 
            display: block; 
            width: 360px; 
            height: 40px; 
            margin: 10px auto; 
            padding: 10px; 
            background-color: #1E3A8A; /* Tmavě modrá tlačítka */
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        .formular .smazat-btn { background-color: #f44336; }
        .formular .schvalit-btn { background-color: #2B4A9B; /* Světlejší tmavě modrá pro schvalovací tlačítko */
        }
        .formular button:hover { 
            background-color: #2B4A9B; /* Světlejší tmavě modrá při najetí */
        }
        .formular .smazat-btn:hover { background-color: #d32f2f; }
        .formular .schvalit-btn:hover { background-color: #3558C1; }
        .hidden { display: none; }
        .search-bar { margin: 20px 0; text-align: center; }
        .search-bar input { 
            width: 360px; 
            height: 40px; 
            padding: 10px; 
            background-color: #1F2937; 
            color: white; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .user-list, .notes-list, .reservations-list { margin-top: 20px; }
        .user-item, .note-item, .reservation-item { 
            padding: 10px; 
            border-bottom: 1px solid #ddd; 
            background-color: #374151; 
        }
        .notification { 
            position: fixed; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            background-color: #ff9800; 
            color: white; 
            padding: 15px; 
            border-radius: 5px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.3); 
            z-index: 1000; 
        }
        .notification .zavrit { 
            cursor: pointer; 
            margin-left: 10px; 
            font-size: 20px; 
        }
        #zakaznik-search-results { 
            position: absolute; 
            background-color: #374151; 
            border: 1px solid #ddd; 
            width: 360px; 
            max-height: 200px; 
            overflow-y: auto; 
            z-index: 10; 
        }
        .zpet-btn { 
            padding: 10px 20px; 
            background-color: #1E3A8A; /* Tmavě modrá */
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 1em; 
        }
        .zpet-btn:hover { 
            background-color: #2B4A9B; /* Světlejší tmavě modrá při najetí */
        }
        .rezervace-list { 
            margin-top: 20px; 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .rezervace-item { 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            margin-bottom: 10px; 
        }
        .rezervace-item { 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            margin-bottom: 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background-color: #374151; 
        }
        .rezervace-item button { 
            padding: 5px 10px; 
            background-color: #ff9800; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        .rezervace-item button:hover { 
            background-color: #e68900; 
        }
        #home-sekce { text-align: center; }
        #home-sekce h2 { color: #1E3A8A; /* Tmavě modrá */
        }
        #home-sekce p { font-size: 1.1em; margin: 20px 0; }
        #home-sekce button { 
            padding: 15px 30px; 
            background-color: #1E3A8A; /* Tmavě modrá */
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 1.2em; 
        }
        #home-sekce button:hover { 
            background-color: #2B4A9B; /* Světlejší tmavě modrá */
        }
    </style>
</head>
<body>
    <div class="hlavicka">
        <div id="scissors-3d"></div>
        <h1>Rezervační systém pro salóny</h1>
        <div class="hlavicka-buttons">
            <button class="zpet-btn" id="zpet-btn" onclick="zobrazitHome()">Hlavní stránka</button>
            <button class="prihlaseni-btn hidden" id="prihlaseni-btn" onclick="zobrazitPrihlaseni()">Přihlášení</button>
            <button class="prihlaseni-btn hidden" id="registrace-btn" onclick="zobrazitRegistraci()">Registrace</button>
            <button class="prihlaseni-btn hidden" id="odhlaseni-btn" onclick="odhlasit()">Odhlásit</button>
        </div>
    </div>

    <!-- Hlavní stránka -->
    <div class="sekce" id="home-sekce">
        <h2>Vítejte u nás!</h2>
        <p>Jsme rezervační systém pro masérská, kosmetická a kadeřnická centra. Nabízíme jednoduché a rychlé rezervace služeb.</p>
        <button onclick="zobrazitRezervace()">Přejít na rezervace</button>
    </div>

    <!-- Rezervační systém -->
    <div class="sekce hidden" id="zakaznici-sekce">
        <div class="datum" id="datum-zakaznici"></div>
        <div class="vyber-datum">
            <input type="date" id="vyber-dne" onchange="zmenitDen(this.value)">
        </div>
        <div class="terminy" id="terminy-zakaznici"></div>
        <div id="moje-rezervace-sekce" class="hidden">
            <h2>Moje rezervace</h2>
            <div id="moje-rezervace-list" class="rezervace-list"></div>
        </div>
    </div>

    <div class="sekce hidden" id="admin-sekce">
        <div class="datum" id="datum-admin"></div>
        <div class="mesic-ovladani">
            <button onclick="predchoziMesic()">Předchozí měsíc</button>
            <button onclick="nasledujiciMesic()">Následující měsíc</button>
        </div>
        <div class="mesic-kalendar" id="mesic-kalendar-admin"></div>
        <div class="vyber-datum">
            <input type="date" id="vyber-dne-admin" onchange="zmenitDenAdmin(this.value)">
        </div>
        <div class="terminy" id="terminy-admin"></div>
        <div class="search-bar">
            <input type="text" id="search-users" placeholder="Hledat uživatele..." oninput="prohledatUzivatele()">
        </div>
        <div class="user-list" id="user-list"></div>
    </div>

    <!-- Formuláře -->
    <div class="formular" id="prihlaseni-form">
        <h3>Přihlášení <span class="zavrit" onclick="zavritPrihlaseni()">×</span></h3>
        <input type="text" id="jmeno" placeholder="Uživatelské jméno">
        <input type="password" id="heslo" placeholder="Heslo">
        <button onclick="prihlasit()">Přihlásit se</button>
    </div>

    <div class="formular" id="registrace-form">
        <h3>Registrace <span class="zavrit" onclick="zavritRegistraci()">×</span></h3>
        <input type="text" id="reg-jmeno" placeholder="Uživatelské jméno" required>
        <input type="email" id="reg-email" placeholder="E-mail" required>
        <input type="text" id="reg-telefon" placeholder="Telefon" required>
        <input type="password" id="reg-heslo" placeholder="Heslo" required>
        <button onclick="registrovat()">Registrovat se</button>
    </div>

    <div class="formular" id="rezervace-form-zakaznik">
        <h3>Nová rezervace <span class="zavrit" onclick="zavritRezervaci()">×</span></h3>
        <input type="text" id="zakaznik-zakaznik" placeholder="Jméno zákazníka" required disabled>
        <select id="sluzba-zakaznik" required>
            <option value="">Vyberte službu</option>
            <option value="Masáž">Masáž</option>
            <option value="Kosmetika">Kosmetika</option>
            <option value="Kadeřnictví">Kadeřnictví</option>
        </select>
        <input type="text" id="telefon-zakaznik" placeholder="Telefon (volitelné)">
        <input type="email" id="email-zakaznik" placeholder="E-mail (volitelné)">
        <textarea id="poznamka-zakaznik" placeholder="Poznámka k rezervaci"></textarea>
        <button onclick="ulozitRezervaciZakaznik()">Uložit</button>
    </div>

    <div class="formular" id="rezervace-form-admin">
        <h3>Nová rezervace <span class="zavrit" onclick="zavritRezervaciAdmin()">×</span></h3>
        <input type="text" id="zakaznik-search" placeholder="Hledat zákazníka..." oninput="hledatZakaznika()">
        <div id="zakaznik-search-results"></div>
        <input type="text" id="zakaznik-admin" placeholder="Jméno zákazníka" required>
        <select id="sluzba-admin" required>
            <option value="">Vyberte službu</option>
            <option value="Masáž">Masáž</option>
            <option value="Kosmetika">Kosmetika</option>
            <option value="Kadeřnictví">Kadeřnictví</option>
        </select>
        <input type="text" id="telefon-admin" placeholder="Telefon (volitelné)">
        <input type="email" id="email-admin" placeholder="E-mail (volitelné)">
        <textarea id="poznamka-admin" placeholder="Poznámka k rezervaci"></textarea>
        <textarea id="interni-poznamka-admin" placeholder="Interní poznámka (vidí jen admin)"></textarea>
        <button onclick="ulozitRezervaciAdmin()">Uložit</button>
    </div>

    <div class="formular" id="editace-form-zakaznik">
        <h3>Upravit rezervaci <span class="zavrit" onclick="zavritEditaci()">×</span></h3>
        <input type="text" id="edit-zakaznik-zakaznik" placeholder="Jméno zákazníka" required>
        <select id="edit-sluzba-zakaznik" required>
            <option value="">Vyberte službu</option>
            <option value="Masáž">Masáž</option>
            <option value="Kosmetika">Kosmetika</option>
            <option value="Kadeřnictví">Kadeřnictví</option>
        </select>
        <input type="text" id="edit-telefon-zakaznik" placeholder="Telefon (volitelné)">
        <input type="email" id="edit-email-zakaznik" placeholder="E-mail (volitelné)">
        <select id="edit-cas-zacatek-zakaznik" required>
            <option value="8:00">8:00</option><option value="8:30">8:30</option><option value="9:00">9:00</option>
            <option value="9:30">9:30</option><option value="10:00">10:00</option><option value="10:30">10:30</option>
            <option value="11:00">11:00</option><option value="11:30">11:30</option><option value="13:00">13:00</option>
            <option value="13:30">13:30</option><option value="14:00">14:00</option><option value="14:30">14:30</option>
            <option value="15:00">15:00</option><option value="15:30">15:30</option>
        </select>
        <select id="edit-cas-konec-zakaznik">
            <option value="">Žádný konec</option>
            <option value="8:30">8:30</option><option value="9:00">9:00</option><option value="9:30">9:30</option>
            <option value="10:00">10:00</option><option value="10:30">10:30</option><option value="11:00">11:00</option>
            <option value="11:30">11:30</option><option value="13:00">13:00</option><option value="13:30">13:30</option>
            <option value="14:00">14:00</option><option value="14:30">14:30</option><option value="15:00">15:00</option>
            <option value="15:30">15:30</option><option value="16:00">16:00</option>
        </select>
        <textarea id="edit-poznamka-zakaznik" placeholder="Poznámka k rezervaci"></textarea>
        <button onclick="ulozitEditaci('zakaznik')">Uložit změny</button>
        <button class="smazat-btn" onclick="smazatRezervaci()">Smazat rezervaci</button>
    </div>

    <div class="formular" id="editace-form-admin">
        <h3>Upravit rezervaci <span class="zavrit" onclick="zavritEditaci()">×</span></h3>
        <input type="text" id="edit-zakaznik-admin" placeholder="Jméno zákazníka" required>
        <select id="edit-sluzba-admin" required>
            <option value="">Vyberte službu</option>
            <option value="Masáž">Masáž</option>
            <option value="Kosmetika">Kosmetika</option>
            <option value="Kadeřnictví">Kadeřnictví</option>
        </select>
        <input type="text" id="edit-telefon-admin" placeholder="Telefon (volitelné)">
        <input type="email" id="edit-email-admin" placeholder="E-mail (volitelné)">
        <select id="edit-cas-zacatek-admin" required>
            <option value="8:00">8:00</option><option value="8:30">8:30</option><option value="9:00">9:00</option>
            <option value="9:30">9:30</option><option value="10:00">10:00</option><option value="10:30">10:30</option>
            <option value="11:00">11:00</option><option value="11:30">11:30</option><option value="13:00">13:00</option>
            <option value="13:30">13:30</option><option value="14:00">14:00</option><option value="14:30">14:30</option>
            <option value="15:00">15:00</option><option value="15:30">15:30</option>
        </select>
        <select id="edit-cas-konec-admin">
            <option value="">Žádný konec</option>
            <option value="8:30">8:30</option><option value="9:00">9:00</option><option value="9:30">9:30</option>
            <option value="10:00">10:00</option><option value="10:30">10:30</option><option value="11:00">11:00</option>
            <option value="11:30">11:30</option><option value="13:00">13:00</option><option value="13:30">13:30</option>
            <option value="14:00">14:00</option><option value="14:30">14:30</option><option value="15:00">15:00</option>
            <option value="15:30">15:30</option><option value="16:00">16:00</option>
        </select>
        <textarea id="edit-poznamka-admin" placeholder="Poznámka k rezervaci"></textarea>
        <textarea id="edit-interni-poznamka-admin" placeholder="Interní poznámka (vidí jen admin)"></textarea>
        <button onclick="ulozitEditaci('admin')">Uložit změny</button>
        <button class="smazat-btn" onclick="smazatRezervaci()">Smazat rezervaci</button>
        <button class="schvalit-btn hidden" id="schvalit-btn" onclick="schvalitRezervaci()">Schválit rezervaci</button>
    </div>

    <div class="formular" id="edit-user-form">
        <h3>Upravit uživatele <span class="zavrit" onclick="zavritEditUser()">×</span></h3>
        <input type="text" id="edit-user-jmeno" placeholder="Jméno" disabled>
        <input type="email" id="edit-user-email" placeholder="E-mail" disabled>
        <input type="text" id="edit-user-telefon" placeholder="Telefon" disabled>
        <input type="password" id="edit-user-heslo" placeholder="Nové heslo">
        <div class="notes-list" id="edit-user-notes"></div>
        <textarea id="edit-user-poznamka" placeholder="Nová poznámka"></textarea>
        <button onclick="pridatPoznamkuAdmin()">Přidat poznámku</button>
        <button onclick="ulozitHeslo()">Změnit heslo</button>
        <div class="reservations-list" id="edit-user-reservations"></div>
    </div>

<script>
    let vybranyDen = new Date();
    let jePrihlasen = false;
    let jeAdmin = false;
    let token = null;
    let userId = null;
    let vybranyZakaznikId = null;
    let vybranyTermin = null;
    const casy = ["8:00", "8:30", "9:00", "9:30", "10:00", "10:30", "11:00", "11:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30"];

    // Inicializace 3D scény pro nůžky
    let scene, camera, renderer, scissorsModel;
    function init3DScene() {
        const container = document.getElementById('scissors-3d');
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        // Osvětlení
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0xffffff, 1, 100);
        pointLight.position.set(5, 5, 5);
        scene.add(pointLight);

        // Načtení modelu nůžek
        const loader = new THREE.GLTFLoader();
        loader.load('/scissors.glb', (gltf) => {
            scissorsModel = gltf.scene;
            scene.add(scissorsModel);

            // Počáteční nastavení modelu
            scissorsModel.scale.set(4, 4, 4); // Velké na začátku (4x)
            scissorsModel.position.set(20, 0, 0); // Mimo obrazovku (vpravo)

            // Upravíme materiál pro kovový vzhled
            scissorsModel.traverse((child) => {
                if (child.isMesh) {
                    child.material.metalness = 0.8;
                    child.material.roughness = 0.2;
                    child.material.color.set(0xC0C0C0); // Stříbrná barva
                }
            });

            // Animace příletu
            gsap.to(scissorsModel.position, {
                x: 0,
                y: 0,
                z: 0,
                duration: 2,
                ease: "power2.out",
                onUpdate: () => {
                    scissorsModel.rotation.z += 0.05; // Točení během příletu
                }
            });

            // Animace zmenšení
            gsap.to(scissorsModel.scale, {
                x: 1,
                y: 1,
                z: 1,
                duration: 1,
                delay: 1,
                ease: "bounce.out"
            });
        }, undefined, (error) => {
            console.error('Chyba při načítání modelu nůžek:', error);
        });

        camera.position.z = 5;

        // Sledování myši
        let targetRotationY = 0;
        let targetRotationX = 0;
        document.addEventListener('mousemove', (event) => {
            if (!scissorsModel) return;

            const rect = container.getBoundingClientRect();
            const mouseX = event.clientX - rect.left - rect.width / 2;
            const mouseY = event.clientY - rect.top - rect.height / 2;

            targetRotationY = (mouseX / rect.width) * Math.PI * 0.5; // Max ±45 stupňů
            targetRotationX = -(mouseY / rect.height) * Math.PI * 0.2; // Max ±20 stupňů
        });

        // Animace scény
        function animate() {
            requestAnimationFrame(animate);
            if (scissorsModel) {
                // Plynulé otáčení směrem k myši
                gsap.to(scissorsModel.rotation, {
                    y: targetRotationY,
                    x: targetRotationX,
                    duration: 0.5,
                    ease: "power2.out"
                });

                // Návrat do výchozí pozice, když myš stojí
                if (Math.abs(targetRotationY) < 0.01 && Math.abs(targetRotationX) < 0.01) {
                    gsap.to(scissorsModel.rotation, {
                        y: 0,
                        x: 0,
                        duration: 1,
                        ease: "power2.out"
                    });
                }
            }
            renderer.render(scene, camera);
        }
        animate();

        // Responzivita
        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });
    }

    // Inicializace stránky
    document.addEventListener('DOMContentLoaded', () => {
        init3DScene();

        // Animace sekcí (fade-in)
        gsap.to(".sekce", { opacity: 1, y: 20, duration: 1, stagger: 0.2 });

        // Animace formulářů
        const formulare = document.querySelectorAll('.formular');
        formulare.forEach(form => {
            form.addEventListener('show', () => {
                gsap.to(form, { opacity: 1, x: 0, duration: 0.5, ease: "power2.out" });
            });
            form.addEventListener('hide', () => {
                gsap.to(form, { opacity: 0, x: 100, duration: 0.5, ease: "power2.in" });
            });
        });

        token = localStorage.getItem('token');
        userId = localStorage.getItem('userId');
        jeAdmin = localStorage.getItem('isAdmin') === 'true';
        jePrihlasen = !!token;

        if (jePrihlasen) {
            fetchUserData().then(data => {
                if (jeAdmin) {
                    zobrazitRezervace();
                    document.getElementById('admin-sekce').classList.remove('hidden');
                    aktualizovatAdmin();
                } else {
                    document.getElementById('odhlaseni-btn').classList.remove('hidden');
                    zobrazitHome();
                }
            }).catch(error => {
                console.error('Chyba při načítání uživatelských dat:', error);
                odhlasit();
            });
        } else {
            zobrazitHome();
        }
    });

    function zobrazitHome() {
        document.getElementById('home-sekce').classList.remove('hidden');
        document.getElementById('zakaznici-sekce').classList.add('hidden');
        document.getElementById('admin-sekce').classList.add('hidden');
        document.getElementById('moje-rezervace-sekce').classList.add('hidden');
        document.getElementById('zpet-btn').classList.add('hidden');
        document.getElementById('prihlaseni-btn').classList.toggle('hidden', jePrihlasen);
        document.getElementById('registrace-btn').classList.toggle('hidden', jePrihlasen);
        document.getElementById('odhlaseni-btn').classList.toggle('hidden', !jePrihlasen);
    }

    function zobrazitRezervace() {
        document.getElementById('home-sekce').classList.add('hidden');
        document.getElementById('zpet-btn').classList.remove('hidden');
        if (jeAdmin) {
            document.getElementById('admin-sekce').classList.remove('hidden');
            document.getElementById('zakaznici-sekce').classList.add('hidden');
            document.getElementById('moje-rezervace-sekce').classList.add('hidden');
            aktualizovatAdmin();
        } else {
            document.getElementById('zakaznici-sekce').classList.remove('hidden');
            document.getElementById('admin-sekce').classList.add('hidden');
            document.getElementById('moje-rezervace-sekce').classList.toggle('hidden', !jePrihlasen);
            aktualizovatZakaznici();
            if (jePrihlasen) zobrazitMojeRezervace();
        }
        document.getElementById('prihlaseni-btn').classList.toggle('hidden', jePrihlasen);
        document.getElementById('registrace-btn').classList.toggle('hidden', jePrihlasen);
        document.getElementById('odhlaseni-btn').classList.toggle('hidden', !jePrihlasen);
    }

    async function fetchReservations(date) {
        try {
            const response = await fetch(`/reservations/${date}`, {
                headers: jePrihlasen ? { 'Authorization': `Bearer ${token}` } : {}
            });
            if (!response.ok) throw new Error('Nepodařilo se načíst rezervace');
            return await response.json();
        } catch (error) {
            console.error('Chyba při načítání rezervací:', error);
            return [];
        }
    }

    async function fetchUserData() {
        try {
            const response = await fetch('/profile', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                throw new Error(`Nepodařilo se načíst data uživatele: ${response.status}`);
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Chyba při načítání uživatelských dat:', error);
            throw error;
        }
    }

    async function fetchUsers(search = '') {
        try {
            const response = await fetch(`/users?search=${search}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Nepodařilo se načíst uživatele');
            return await response.json();
        } catch (error) {
            console.error('Chyba při načítání uživatelů:', error);
            return [];
        }
    }

    async function fetchUserReservations(userId) {
        try {
            const response = await fetch(`/users/${userId}/reservations`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Nepodařilo se načíst rezervace uživatele');
            return await response.json();
        } catch (error) {
            console.error('Chyba při načítání rezervací uživatele:', error);
            return [];
        }
    }

    async function fetchDeletedReservations() {
        try {
            const response = await fetch('/reservations/deleted', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Nepodařilo se načíst smazané rezervace');
            return await response.json();
        } catch (error) {
            console.error('Chyba při načítání smazaných rezervací:', error);
            return [];
        }
    }

    async function aktualizovatZakaznici() {
        const datumZakaznici = document.getElementById('datum-zakaznici');
        const vyberDne = document.getElementById('vyber-dne');
        vyberDne.value = vybranyDen.toISOString().split('T')[0];
        datumZakaznici.textContent = `Rezervace na ${vybranyDen.toLocaleDateString('cs-CZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
        document.getElementById('datum-admin').textContent = '';
        await aktualizovatTerminy('terminy-zakaznici', false);
    }

    async function aktualizovatAdmin() {
        const datumAdmin = document.getElementById('datum-admin');
        const vyberDneAdmin = document.getElementById('vyber-dne-admin');
        vyberDneAdmin.value = vybranyDen.toISOString().split('T')[0];
        datumAdmin.textContent = `Správa rezervací na ${vybranyDen.toLocaleDateString('cs-CZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
        document.getElementById('datum-zakaznici').textContent = '';
        await aktualizovatMesicKalendar();
        await aktualizovatTerminy('terminy-admin', true);
        await prohledatUzivatele();
        if (jeAdmin) await zobrazitNotifikaciSmazanych();
    }

    async function aktualizovatMesicKalendar() {
        const kalendar = document.getElementById('mesic-kalendar-admin');
        kalendar.innerHTML = '';
        const prvniDen = new Date(vybranyDen.getFullYear(), vybranyDen.getMonth(), 1);
        const posledniDen = new Date(vybranyDen.getFullYear(), vybranyDen.getMonth() + 1, 0);
        const startDen = prvniDen.getDay() || 7;

        for (let i = 1; i < startDen; i++) {
            const div = document.createElement('div');
            div.classList.add('den');
            kalendar.appendChild(div);
        }

        for (let i = 1; i <= posledniDen.getDate(); i++) {
            const den = new Date(vybranyDen.getFullYear(), vybranyDen.getMonth(), i);
            const denKey = den.toISOString().split('T')[0];
            const reservations = await fetchReservations(denKey);
            const div = document.createElement('div');
            div.classList.add('den');
            div.textContent = i;
            const maVolne = casy.some(cas => !reservations.some(r => r.time === cas && r.approved && !r.deleted));
            div.classList.add(maVolne ? 'volny' : 'obsazeny');
            div.addEventListener('click', () => {
                vybranyDen = den;
                aktualizovatAdmin();
            });
            kalendar.appendChild(div);
        }
    }

    async function aktualizovatTerminy(terminyId, editMode) {
        const terminyList = document.getElementById(terminyId);
        terminyList.innerHTML = '';
        const denKey = vybranyDen.toISOString().split('T')[0];
        const reservations = await fetchReservations(denKey);

        casy.forEach(cas => {
            const reservation = reservations.find(r => r.time === cas);
            const div = document.createElement('div');
            div.classList.add('termin');
            div.dataset.id = reservation ? reservation.id : null;
            div.textContent = reservation ? `${reservation.time}${reservation.timeEnd ? ` - ${reservation.timeEnd}` : ''}` : cas;

            if (!reservation) {
                div.classList.add('volny');
            } else if (reservation.deleted) {
                div.classList.add('smazany');
            } else if (!reservation.approved) {
                div.classList.add('cekajici');
            } else {
                div.classList.add('obsazeny');
            }

            if (reservation && (editMode || (jePrihlasen && reservation.userId === userId))) {
                const podrobnosti = document.createElement('div');
                podrobnosti.classList.add('podrobnosti');
                let text = `${reservation.zakaznik} - ${reservation.serviceType}`;
                if (reservation.telefon) text += `\nTel: ${reservation.telefon}`;
                if (reservation.email) text += `\nEmail: ${reservation.email}`;
                if (reservation.note) text += `\nPoznámka: ${reservation.note}`;
                if (editMode && jeAdmin && reservation.internalNote) text += `\nInterní poznámka: ${reservation.internalNote}`;
                if (!reservation.approved) text += `\n(Čeká na schválení)`;
                if (reservation.deleted) text += `\n(Smazáno zákazníkem)`;
                podrobnosti.textContent = text;
                div.appendChild(podrobnosti);
            }

            div.addEventListener('click', async () => {
                if (!jePrihlasen) return alert("Musíte být přihlášeni k rezervaci nebo úpravě!");
                if (editMode && reservation) {
                    vybranyTermin = reservation;
                    zobrazitEditaci();
                } else if ((editMode || jePrihlasen) && !reservation) {
                    vybranyTermin = { date: denKey, time: cas };
                    jeAdmin ? zobrazitRezervaciAdmin() : zobrazitRezervaciZakaznik();
                }
            });

            terminyList.appendChild(div);
        });
    }

    async function prohledatUzivatele() {
        if (!jeAdmin) return;
        const search = document.getElementById('search-users').value;
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        const users = await fetchUsers(search);
        users.forEach(user => {
            const div = document.createElement('div');
            div.classList.add('user-item');
            div.innerHTML = `
                ${user.username} (${user.email}) 
                <button onclick="upravitUzivatele(${user.id})">Upravit</button>
                <button onclick="toggleAdmin(${user.id}, ${user.isAdmin})">${user.isAdmin ? 'Odebrat admina' : 'Přidat admina'}</button>
                <button onclick="smazatUzivatele(${user.id})">Smazat</button>
            `;
            userList.appendChild(div);
        });
    }

    async function toggleAdmin(userId, currentIsAdmin) {
        const potvrzeni = confirm(`Opravdu chcete ${currentIsAdmin ? 'odebrat' : 'přidat'} admin práva uživateli?`);
        if (potvrzeni) {
            try {
                const response = await fetch(`/users/${userId}/toggle-admin`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    alert('Role změněna.');
                    prohledatUzivatele();
                } else {
                    alert('Nepodařilo se změnit roli.');
                }
            } catch (error) {
                console.error('Chyba při změně role:', error);
                alert('Nastala chyba při změně role.');
            }
        }
    }

    async function smazatUzivatele(userId) {
        const potvrzeni = confirm('Opravdu chcete smazat tohoto uživatele a jeho rezervace?');
        if (potvrzeni) {
            try {
                const response = await fetch(`/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    alert('Uživatel smazán.');
                    prohledatUzivatele();
                } else {
                    alert('Nepodařilo se smazat uživatele.');
                }
            } catch (error) {
                console.error('Chyba při mazání uživatele:', error);
                alert('Nastala chyba při mazání uživatele.');
            }
        }
    }

    function predchoziMesic() {
        vybranyDen.setMonth(vybranyDen.getMonth() - 1);
        aktualizovatAdmin();
    }

    function nasledujiciMesic() {
        vybranyDen.setMonth(vybranyDen.getMonth() + 1);
        aktualizovatAdmin();
    }

    function zmenitDen(datum) {
        vybranyDen = new Date(datum);
        aktualizovatZakaznici();
    }

    function zmenitDenAdmin(datum) {
        vybranyDen = new Date(datum);
        aktualizovatAdmin();
    }

    function zobrazitPrihlaseni() {
        const form = document.getElementById('prihlaseni-form');
        form.style.display = 'block';
        form.dispatchEvent(new Event('show'));
    }

    function zavritPrihlaseni() {
        const form = document.getElementById('prihlaseni-form');
        form.dispatchEvent(new Event('hide'));
        setTimeout(() => form.style.display = 'none', 500);
    }

    function zobrazitRegistraci() {
        const form = document.getElementById('registrace-form');
        form.style.display = 'block';
        form.dispatchEvent(new Event('show'));
    }

    function zavritRegistraci() {
        const form = document.getElementById('registrace-form');
        form.dispatchEvent(new Event('hide'));
        setTimeout(() => form.style.display = 'none', 500);
    }

    async function prihlasit() {
        const jmeno = document.getElementById('jmeno').value;
        const heslo = document.getElementById('heslo').value;
        try {
            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ jmeno, heslo })
            });
            const result = await response.json();
            if (result.success) {
                token = result.token;
                jePrihlasen = true;
                userId = result.userId;
                jeAdmin = result.isAdmin;
                localStorage.setItem('token', token);
                localStorage.setItem('userId', userId);
                localStorage.setItem('isAdmin', jeAdmin);
                zavritPrihlaseni();
                document.getElementById('prihlaseni-btn').classList.add('hidden');
                document.getElementById('registrace-btn').classList.add('hidden');
                document.getElementById('odhlaseni-btn').classList.remove('hidden');
                fetchUserData().then(data => {
                    zobrazitRezervace();
                }).catch(error => {
                    console.error('Chyba při načítání uživatelských dat po přihlášení:', error);
                    odhlasit();
                });
            } else {
                alert(result.message || "Špatné jméno nebo heslo!");
            }
        } catch (error) {
            console.error('Chyba při přihlášení:', error);
            alert('Nastala chyba při přihlášení.');
        }
    }

    async function registrovat() {
        const jmeno = document.getElementById('reg-jmeno').value;
        const email = document.getElementById('reg-email').value;
        const telefon = document.getElementById('reg-telefon').value;
        const heslo = document.getElementById('reg-heslo').value;
        if (jmeno && email && telefon && heslo) {
            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jmeno, email, telefon, heslo })
                });
                const result = await response.json();
                if (result.success) {
                    alert("Registrace úspěšná! Nyní se můžete přihlásit.");
                    zavritRegistraci();
                } else {
                    alert(result.message || "Registrace selhala.");
                }
            } catch (error) {
                console.error('Chyba při registraci:', error);
                alert('Nastala chyba při registraci.');
            }
        } else {
            alert("Vyplňte všechna pole!");
        }
    }

    function odhlasit() {
        jePrihlasen = false;
        jeAdmin = false;
        token = null;
        userId = null;
        vybranyZakaznikId = null;
        localStorage.clear();
        document.getElementById('odhlaseni-btn').classList.add('hidden');
        document.getElementById('prihlaseni-btn').classList.remove('hidden');
        document.getElementById('registrace-btn').classList.remove('hidden');
        document.getElementById('moje-rezervace-sekce').classList.add('hidden');
        document.getElementById('moje-rezervace-list').innerHTML = '';
        document.getElementById('datum-zakaznici').textContent = '';
        document.getElementById('datum-admin').textContent = '';
        zobrazitHome();
    }

    async function zobrazitRezervaciZakaznik() {
        if (!jePrihlasen || jeAdmin) return alert("Musíte být přihlášeni jako zákazník!");
        try {
            const userData = await fetchUserData();
            const form = document.getElementById('rezervace-form-zakaznik');
            form.style.display = 'block';
            form.dispatchEvent(new Event('show'));
            document.getElementById('zakaznik-zakaznik').value = userData.username;
            document.getElementById('telefon-zakaznik').value = userData.telefon;
            document.getElementById('email-zakaznik').value = userData.email;
        } catch (error) {
            console.error('Chyba při načítání dat pro rezervaci:', error);
            alert('Nastala chyba při načítání dat.');
        }
    }

    async function zobrazitRezervaciAdmin() {
        if (!jePrihlasen || !jeAdmin) return alert("Musíte být přihlášeni jako admin!");
        const form = document.getElementById('rezervace-form-admin');
        form.style.display = 'block';
        form.dispatchEvent(new Event('show'));
        document.getElementById('zakaznik-search').value = '';
        document.getElementById('zakaznik-admin').value = '';
        document.getElementById('telefon-admin').value = '';
        document.getElementById('email-admin').value = '';
        vybranyZakaznikId = null;
    }

    async function hledatZakaznika() {
        const search = document.getElementById('zakaznik-search').value;
        const resultsDiv = document.getElementById('zakaznik-search-results');
        resultsDiv.innerHTML = '';
        if (search.length < 2) return;

        const users = await fetchUsers(search);
        users.forEach(user => {
            const div = document.createElement('div');
            div.textContent = `${user.username} (${user.email})`;
            div.onclick = async () => {
                vybranyZakaznikId = user.id;
                document.getElementById('zakaznik-admin').value = user.username;
                document.getElementById('telefon-admin').value = user.telefon;
                document.getElementById('email-admin').value = user.email;
                resultsDiv.innerHTML = '';
            };
            resultsDiv.appendChild(div);
        });
    }

    function zavritRezervaci() {
        const form = document.getElementById('rezervace-form-zakaznik');
        form.dispatchEvent(new Event('hide'));
        setTimeout(() => form.style.display = 'none', 500);
    }

    function zavritRezervaciAdmin() {
        const form = document.getElementById('rezervace-form-admin');
        form.dispatchEvent(new Event('hide'));
        setTimeout(() => form.style.display = 'none', 500);
    }

    async function ulozitRezervaciZakaznik() {
        const zakaznik = document.getElementById('zakaznik-zakaznik').value;
        const serviceType = document.getElementById('sluzba-zakaznik').value;
        const telefon = document.getElementById('telefon-zakaznik').value;
        const email = document.getElementById('email-zakaznik').value;
        const poznamka = document.getElementById('poznamka-zakaznik').value;

        if (!zakaznik || !serviceType) return alert("Vyplňte všechna povinná pole!");

        try {
            const response = await fetch('/reservations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    date: vybranyTermin.date,
                    time: vybranyTermin.time,
                    zakaznik,
                    serviceType,
                    telefon,
                    email,
                    note: poznamka
                })
            });
            if (response.ok) {
                alert("Rezervace uložena, čeká na schválení.");
                zavritRezervaci();
                aktualizovatZakaznici();
                zobrazitMojeRezervace();
            } else {
                const errorData = await response.json();
                alert(`Nepodařilo se uložit rezervaci: ${errorData.message || 'Není k dispozici podrobnější informace.'}`);
            }
        } catch (error) {
            console.error('Chyba při ukládání rezervace:', error);
            alert('Nastala chyba při ukládání rezervace.');
        }
    }

    async function ulozitRezervaciAdmin() {
        const zakaznik = document.getElementById('zakaznik-admin').value;
        const serviceType = document.getElementById('sluzba-admin').value;
        const telefon = document.getElementById('telefon-admin').value;
        const email = document.getElementById('email-admin').value;
        const poznamka = document.getElementById('poznamka-admin').value;
        const interniPoznamka = document.getElementById('interni-poznamka-admin').value;

        if (!zakaznik || !serviceType) return alert("Vyplňte všechna povinná pole!");

        try {
            const response = await fetch('/reservations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    date: vybranyTermin.date,
                    time: vybranyTermin.time,
                    zakaznik,
                    serviceType,
                    telefon,
                    email,
                    note: poznamka,
                    internalNote: interniPoznamka,
                    userId: vybranyZakaznikId,
                    approved: true
                })
            });
            if (response.ok) {
                alert("Rezervace uložena.");
                zavritRezervaciAdmin();
                aktualizovatAdmin();
            } else {
                const errorData = await response.json();
                alert(`Nepodařilo se uložit rezervaci: ${errorData.message || 'Není k dispozici podrobnější informace.'}`);
            }
        } catch (error) {
            console.error('Chyba při ukládání rezervace:', error);
            alert('Nastala chyba při ukládání rezervace.');
        }
    }

    async function zobrazitEditaci() {
        if (!vybranyTermin) return;
        const formId = jeAdmin ? 'editace-form-admin' : 'editace-form-zakaznik';
        const prefix = jeAdmin ? 'edit-' : 'edit-';
        const suffix = jeAdmin ? '-admin' : '-zakaznik';

        const form = document.getElementById(formId);
        form.style.display = 'block';
        form.dispatchEvent(new Event('show'));
        document.getElementById(`${prefix}zakaznik${suffix}`).value = vybranyTermin.zakaznik;
        document.getElementById(`${prefix}sluzba${suffix}`).value = vybranyTermin.serviceType;
        document.getElementById(`${prefix}telefon${suffix}`).value = vybranyTermin.telefon || '';
        document.getElementById(`${prefix}email${suffix}`).value = vybranyTermin.email || '';
        document.getElementById(`${prefix}poznamka${suffix}`).value = vybranyTermin.note || '';
        if (jeAdmin) document.getElementById('edit-interni-poznamka-admin').value = vybranyTermin.internalNote || '';
        document.getElementById(`${prefix}cas-zacatek${suffix}`).value = vybranyTermin.time;
        document.getElementById(`${prefix}cas-konec${suffix}`).value = vybranyTermin.timeEnd || '';

        if (jeAdmin) {
            document.getElementById('schvalit-btn').classList.toggle('hidden', vybranyTermin.approved);
        }
    }

    function zavritEditaci() {
        const formZakaznik = document.getElementById('editace-form-zakaznik');
        const formAdmin = document.getElementById('editace-form-admin');
        formZakaznik.dispatchEvent(new Event('hide'));
        formAdmin.dispatchEvent(new Event('hide'));
        setTimeout(() => {
            formZakaznik.style.display = 'none';
            formAdmin.style.display = 'none';
        }, 500);
    }

    async function ulozitEditaci(mode) {
        const suffix = mode === 'admin' ? '-admin' : '-zakaznik';
        const zakaznik = document.getElementById(`edit-zakaznik${suffix}`).value;
        const serviceType = document.getElementById(`edit-sluzba${suffix}`).value;
        const telefon = document.getElementById(`edit-telefon${suffix}`).value;
        const email = document.getElementById(`edit-email${suffix}`).value;
        const casZacatek = document.getElementById(`edit-cas-zacatek${suffix}`).value;
        const casKonec = document.getElementById(`edit-cas-konec${suffix}`).value;
        const poznamka = document.getElementById(`edit-poznamka${suffix}`).value;
        const interniPoznamka = mode === 'admin' ? document.getElementById('edit-interni-poznamka-admin').value : '';

        if (!zakaznik || !serviceType) return alert("Vyplňte všechna povinná pole!");

        try {
            const response = await fetch(`/reservations/${vybranyTermin.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    date: vybranyTermin.date,
                    time: casZacatek,
                    timeEnd: casKonec,
                    zakaznik,
                    serviceType,
                    telefon,
                    email,
                    note: poznamka,
                    internalNote: interniPoznamka,
                    approved: mode === 'admin' ? vybranyTermin.approved : false
                })
            });
            if (response.ok) {
                alert("Rezervace upravena.");
                zavritEditaci();
                if (mode === 'admin') {
                    aktualizovatAdmin();
                } else {
                    aktualizovatZakaznici();
                    zobrazitMojeRezervace();
                }
            } else {
                const errorData = await response.json();
                alert(`Nepodařilo se upravit rezervaci: ${errorData.message || 'Není k dispozici podrobnější informace.'}`);
            }
        } catch (error) {
            console.error('Chyba při úpravě rezervace:', error);
            alert('Nastala chyba při úpravě rezervace.');
        }
    }

    async function smazatRezervaci() {
        const potvrzeni = confirm("Opravdu chcete smazat tuto rezervaci?");
        if (!potvrzeni) return;

        try {
            const response = await fetch(`/reservations/${vybranyTermin.id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                alert("Rezervace smazána.");
                zavritEditaci();
                if (jeAdmin) {
                    aktualizovatAdmin();
                } else {
                    aktualizovatZakaznici();
                    zobrazitMojeRezervace();
                }
            } else {
                const errorData = await response.json();
                alert(`Nepodařilo se smazat rezervaci: ${errorData.message || 'Není k dispozici podrobnější informace.'}`);
            }
        } catch (error) {
            console.error('Chyba při mazání rezervace:', error);
            alert('Nastala chyba při mazání rezervace.');
        }
    }

    async function schvalitRezervaci() {
        try {
            const response = await fetch(`/reservations/${vybranyTermin.id}/approve`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                alert("Rezervace schválena.");
                zavritEditaci();
                aktualizovatAdmin();
            } else {
                const errorData = await response.json();
                alert(`Nepodařilo se schválit rezervaci: ${errorData.message || 'Není k dispozici podrobnější informace.'}`);
            }
        } catch (error) {
            console.error('Chyba při schvalování rezervace:', error);
            alert('Nastala chyba při schvalování rezervace.');
        }
    }

    async function zobrazitMojeRezervace() {
        if (!jePrihlasen || jeAdmin) return;
        const list = document.getElementById('moje-rezervace-list');
        list.innerHTML = '';
        const reservations = await fetchUserReservations(userId);
        reservations.forEach(reservation => {
            const div = document.createElement('div');
            div.classList.add('rezervace-item');
            const date = new Date(reservation.date);
            div.innerHTML = `
                <span>${date.toLocaleDateString('cs-CZ')} ${reservation.time}${reservation.timeEnd ? ` - ${reservation.timeEnd}` : ''}: ${reservation.serviceType} (${reservation.approved ? 'Schváleno' : 'Čeká na schválení'})</span>
                <button onclick="upravitMojiRezervaci(${reservation.id})">Upravit</button>
            `;
            list.appendChild(div);
        });
    }

    async function upravitMojiRezervaci(reservationId) {
        const reservations = await fetchUserReservations(userId);
        vybranyTermin = reservations.find(r => r.id === reservationId);
        if (vybranyTermin) {
            zobrazitEditaci();
        }
    }

    async function upravitUzivatele(userId) {
        try {
            const response = await fetch(`/users/${userId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const user = await response.json();
            const form = document.getElementById('edit-user-form');
            form.style.display = 'block';
            form.dispatchEvent(new Event('show'));
            document.getElementById('edit-user-jmeno').value = user.username;
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-telefon').value = user.telefon;
            document.getElementById('edit-user-heslo').value = '';
            document.getElementById('edit-user-poznamka').value = '';

            const notesList = document.getElementById('edit-user-notes');
            notesList.innerHTML = '';
            user.notes.forEach(note => {
                const div = document.createElement('div');
                div.classList.add('note-item');
                div.textContent = note;
                notesList.appendChild(div);
            });

            const reservationsList = document.getElementById('edit-user-reservations');
            reservationsList.innerHTML = '';
            const reservations = await fetchUserReservations(userId);
            reservations.forEach(reservation => {
                const div = document.createElement('div');
                div.classList.add('reservation-item');
                const date = new Date(reservation.date);
                div.textContent = `${date.toLocaleDateString('cs-CZ')} ${reservation.time}${reservation.timeEnd ? ` - ${reservation.timeEnd}` : ''}: ${reservation.serviceType}`;
                reservationsList.appendChild(div);
            });
        } catch (error) {
            console.error('Chyba při načítání uživatele:', error);
            alert('Nastala chyba při načítání uživatele.');
        }
    }

    async function pridatPoznamkuAdmin() {
        const poznamka = document.getElementById('edit-user-poznamka').value;
        if (!poznamka) return alert("Zadejte poznámku!");

        try {
            const response = await fetch(`/users/${vybranyZakaznikId}/notes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ note: poznamka })
            });
            if (response.ok) {
                alert("Poznámka přidána.");
                document.getElementById('edit-user-poznamka').value = '';
                upravitUzivatele(vybranyZakaznikId);
            } else {
                alert("Nepodařilo se přidat poznámku.");
            }
        } catch (error) {
            console.error('Chyba při přidávání poznámky:', error);
            alert('Nastala chyba při přidávání poznámky.');
        }
    }

    async function ulozitHeslo() {
        const heslo = document.getElementById('edit-user-heslo').value;
        if (!heslo) return alert("Zadejte nové heslo!");

        try {
            const response = await fetch(`/users/${vybranyZakaznikId}/password`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ heslo })
            });
            if (response.ok) {
                alert("Heslo změněno.");
                document.getElementById('edit-user-heslo').value = '';
            } else {
                alert("Nepodařilo se změnit heslo.");
            }
        } catch (error) {
            console.error('Chyba při změně hesla:', error);
            alert('Nastala chyba při změně hesla.');
        }
    }

    function zavritEditUser() {
        const form = document.getElementById('edit-user-form');
        form.dispatchEvent(new Event('hide'));
        setTimeout(() => form.style.display = 'none', 500);
    }

    async function zobrazitNotifikaciSmazanych() {
        const smazane = await fetchDeletedReservations();
        if (smazane.length > 0) {
            const div = document.createElement('div');
            div.classList.add('notification');
            div.innerHTML = `Existují smazané rezervace (${smazane.length}) <span class="zavrit" onclick="this.parentElement.remove()">×</span>`;
            document.body.appendChild(div);
        }
    }
</script>
</body>
</html>
