<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezervace - Veterinární ordinace</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f0f0f0;
        overflow-y: auto; /* Přidáno rolování celé stránky */
    }

    .hlavicka {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background-color: #4CAF50;
        color: white;
    }

    .hlavicka h1 {
        margin: 0;
    }

    .hlavicka-buttons {
        display: flex;
        gap: 10px;
    }

    .prihlaseni-btn {
        padding: 10px 20px;
        width: 160px;
        background-color: #ffffff;
        color: #4CAF50;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        text-align: center;
    }

    .prihlaseni-btn:hover {
        background-color: #e0e0e0;
    }

    .sekce {
        max-width: 1000px;
        margin: 20px auto;
        padding: 20px;
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .datum {
        text-align: center;
        font-size: 1.2em;
        margin-bottom: 20px;
    }

    .vyber-datum {
        text-align: center;
        margin-bottom: 20px;
    }

    .vyber-datum input[type="date"] {
        padding: 10px;
        font-size: 1em;
        border: 1px solid #ddd;
        border-radius: 5px;
        width: 360px;
        height: 40px;
    }

    .mesic-kalendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        text-align: center;
        margin-bottom: 20px;
    }

    .den {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
    }

    .den.volny {
        background-color: #4CAF50;
        color: white;
    }

    .den.obsazeny {
        background-color: #f44336;
        color: white;
    }

    .den:hover:not(.obsazeny) {
        background-color: #45a049;
    }

    .terminy {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 20px;
    }

    .termin {
        padding: 15px;
        text-align: center;
        border-radius: 5px;
        cursor: pointer;
    }

    .volny {
        background-color: #4CAF50;
        color: white;
    }

    .obsazeny {
        background-color: #f44336;
        color: white;
    }

    .cekajici {
        background-color: #ff9800;
        color: white;
    }

    .smazany {
        background-color: #9e9e9e;
        color: white;
    }

    .volny:hover {
        background-color: #45a049;
    }

    .obsazeny:hover {
        background-color: #d32f2f;
    }

    .cekajici:hover {
        background-color: #e68a00;
    }

    .smazany:hover {
        background-color: #757575;
    }

    .podrobnosti {
        font-size: 0.9em;
        margin-top: 5px;
    }

    .mesic-ovladani {
        text-align: center;
        margin-bottom: 10px;
    }

    .mesic-ovladani button {
        padding: 8px 16px;
        margin: 0 5px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .mesic-ovladani button:hover {
        background-color: #45a049;
    }

    .formular {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        width: 100%;
        max-width: 400px; /* Omezení šířky pro #edit-user-form */
        max-height: 80vh; /* Omezení výšky */
        overflow-y: auto; /* Vnitřní rolování formuláře */
    }

    .formular h3 {
        margin: 0 0 20px 0;
        text-align: center;
    }

    .formular .zavrit {
        position: absolute;
        right: 10px;
        top: 5px;
        font-size: 20px;
        cursor: pointer;
        color: #f44336;
    }

    .formular input, .formular select, .formular textarea {
        display: block;
        width: 100%; /* Plná šířka uvnitř formuláře */
        max-width: 360px; /* Maximální šířka polí */
        height: 40px;
        margin: 10px auto;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
    }

    .formular textarea {
        height: 80px;
    }

    .formular button {
        display: block;
        width: 100%;
        max-width: 360px;
        height: 40px;
        margin: 10px auto;
        padding: 10px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .formular .smazat-btn {
        background-color: #f44336;
    }

    .formular .schvalit-btn {
        background-color: #2196F3;
    }

    .formular button:hover {
        background-color: #45a049;
    }

    .formular .smazat-btn:hover {
        background-color: #d32f2f;
    }

    .formular .schvalit-btn:hover {
        background-color: #1976D2;
    }

    .hidden {
        display: none;
    }

    .search-bar {
        margin: 20px 0;
        text-align: center;
    }

    .search-bar input {
        width: 360px;
        height: 40px;
        padding: 10px;
    }

    .user-list, .notes-list, .reservations-list {
        margin-top: 20px;
        max-height: 150px; /* Omezení výšky seznamů */
        overflow-y: auto; /* Rolování uvnitř seznamů */
    }

    .user-item, .note-item, .reservation-item {
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }

    .pet-list {
        margin-top: 10px;
    }

    .pet-item {
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 5px;
    }

    .notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #ff9800;
        color: white;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        z-index: 1000;
    }

    .notification .zavrit {
        cursor: pointer;
        margin-left: 10px;
        font-size: 20px;
    }

    #zakaznik-search-results {
        position: absolute;
        background-color: white;
        border: 1px solid #ddd;
        width: 360px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 10;
    }

    #zakaznik-search-results div {
        padding: 10px;
        cursor: pointer;
    }

    #zakaznik-search-results div:hover {
        background-color: #f0f0f0;
    }
</style>
</head>
<body>
    <div class="hlavicka">
        <h1>Veterinární ordinace - Rezervace</h1>
        <div class="hlavicka-buttons">
            <button class="prihlaseni-btn" onclick="zobrazitPrihlaseni()">Přihlášení</button>
            <button class="prihlaseni-btn" onclick="zobrazitRegistraci()">Registrace</button>
            <button class="prihlaseni-btn hidden" id="pridat-mazlicka-btn" onclick="zobrazitPridaniMazlicka()">Přidat mazlíčka</button>
            <button class="prihlaseni-btn hidden" id="odhlaseni-btn" onclick="odhlasit()">Odhlásit</button>
        </div>
    </div>

    <div class="sekce" id="zakaznici-sekce">
        <div class="datum" id="datum-zakaznici"></div>
        <div class="vyber-datum">
            <input type="date" id="vyber-dne" onchange="zmenitDen(this.value)">
        </div>
        <div class="terminy" id="terminy-zakaznici"></div>
    </div>

    <div class="sekce hidden" id="admin-sekce">
        <div class="datum" id="datum-admin"></div>
        <div class="mesic-ovladani">
            <button onclick="predchoziMesic()">Předchozí měsíc</button>
            <button onclick="nasledujiciMesic()">Následující měsíc</button>
        </div>
        <div class="mesic-kalendar" id="mesic-kalendar-admin"></div>
        <div class="vyber-datum">
            <input type="date" id="vyber-dne-admin" onchange="zmenitDenAdmin(this.value)">
        </div>
        <div class="terminy" id="terminy-admin"></div>
        <div class="search-bar">
            <input type="text" id="search-users" placeholder="Hledat uživatele..." oninput="prohledatUzivatele()">
        </div>
        <div class="user-list" id="user-list"></div>
    </div>

    <div class="formular" id="prihlaseni-form">
        <h3>Přihlášení <span class="zavrit" onclick="zavritPrihlaseni()">×</span></h3>
        <input type="text" id="jmeno" placeholder="Uživatelské jméno">
        <input type="password" id="heslo" placeholder="Heslo">
        <button onclick="prihlasit()">Přihlásit se</button>
    </div>

    <div class="formular" id="registrace-form">
        <h3>Registrace <span class="zavrit" onclick="zavritRegistraci()">×</span></h3>
        <input type="text" id="reg-jmeno" placeholder="Uživatelské jméno" required>
        <input type="email" id="reg-email" placeholder="E-mail" required>
        <input type="text" id="reg-telefon" placeholder="Telefon" required>
        <input type="password" id="reg-heslo" placeholder="Heslo" required>
        <button onclick="registrovat()">Registrovat se</button>
    </div>

    <!-- Formulář pro zákazníka -->
    <div class="formular" id="rezervace-form-zakaznik">
        <h3>Nová rezervace <span class="zavrit" onclick="zavritRezervaci()">×</span></h3>
        <input type="text" id="zakaznik-zakaznik" placeholder="Jméno zákazníka" required disabled>
        <select id="zvire-zakaznik" class="zvire-select" required></select>
        <input type="text" id="duvod-zakaznik" placeholder="Důvod návštěvy" required>
        <input type="text" id="telefon-zakaznik" placeholder="Telefon (volitelné)">
        <input type="email" id="email-zakaznik" placeholder="E-mail (volitelné)">
        <textarea id="poznamka-zakaznik" placeholder="Poznámka k rezervaci"></textarea>
        <button onclick="ulozitRezervaciZakaznik()">Uložit</button>
    </div>

    <!-- Formulář pro admina -->
    <div class="formular" id="rezervace-form-admin">
        <h3>Nová rezervace <span class="zavrit" onclick="zavritRezervaciAdmin()">×</span></h3>
        <input type="text" id="zakaznik-search" placeholder="Hledat zákazníka..." oninput="hledatZakaznika()">
        <div id="zakaznik-search-results"></div>
        <input type="text" id="zakaznik-admin" placeholder="Jméno zákazníka" required>
        <select id="zvire-admin" class="zvire-select"></select>
        <input type="text" id="duvod-admin" placeholder="Důvod návštěvy" required>
        <input type="text" id="telefon-admin" placeholder="Telefon (volitelné)">
        <input type="email" id="email-admin" placeholder="E-mail (volitelné)">
        <textarea id="poznamka-admin" placeholder="Poznámka k rezervaci"></textarea>
        <textarea id="interni-poznamka-admin" placeholder="Interní poznámka (vidí jen admin)"></textarea>
        <button onclick="ulozitRezervaciAdmin()">Uložit</button>
    </div>

    <div class="formular" id="editace-form">
        <h3>Upravit rezervaci <span class="zavrit" onclick="zavritEditaci()">×</span></h3>
        <input type="text" id="edit-zakaznik" placeholder="Jméno zákazníka" required>
        <select id="edit-zvire" class="zvire-select"></select>
        <input type="text" id="edit-duvod" placeholder="Důvod návštěvy" required>
        <input type="text" id="edit-telefon" placeholder="Telefon (volitelné)">
        <input type="email" id="edit-email" placeholder="E-mail (volitelné)">
        <select id="edit-cas-zacatek" required>
            <option value="8:00">8:00</option><option value="8:30">8:30</option><option value="9:00">9:00</option>
            <option value="9:30">9:30</option><option value="10:00">10:00</option><option value="10:30">10:30</option>
            <option value="11:00">11:00</option><option value="11:30">11:30</option><option value="13:00">13:00</option>
            <option value="13:30">13:30</option><option value="14:00">14:00</option><option value="14:30">14:30</option>
            <option value="15:00">15:00</option><option value="15:30">15:30</option>
        </select>
        <select id="edit-cas-konec">
            <option value="">Žádný konec</option>
            <option value="8:30">8:30</option><option value="9:00">9:00</option><option value="9:30">9:30</option>
            <option value="10:00">10:00</option><option value="10:30">10:30</option><option value="11:00">11:00</option>
            <option value="11:30">11:30</option><option value="13:00">13:00</option><option value="13:30">13:30</option>
            <option value="14:00">14:00</option><option value="14:30">14:30</option><option value="15:00">15:00</option>
            <option value="15:30">15:30</option><option value="16:00">16:00</option>
        </select>
        <textarea id="edit-poznamka" placeholder="Poznámka k rezervaci"></textarea>
        <textarea id="edit-interni-poznamka" placeholder="Interní poznámka (vidí jen admin)" class="hidden"></textarea>
        <button onclick="ulozitEditaci()">Uložit změny</button>
        <button class="smazat-btn" onclick="smazatRezervaci()">Smazat rezervaci</button>
        <button class="schvalit-btn hidden" id="schvalit-btn" onclick="schvalitRezervaci()">Schválit rezervaci</button>
    </div>

    <div class="formular" id="pridani-mazlicka-form">
        <h3>Přidat mazlíčka <span class="zavrit" onclick="zavritPridaniMazlicka()">×</span></h3>
        <input type="text" id="novy-mazlicek" placeholder="Jméno mazlíčka" required>
        <select id="druh-zvirete" onchange="zobrazitJine()" required>
            <option value="">Vyberte druh</option>
            <option value="Pes">Pes</option>
            <option value="Kočka">Kočka</option>
            <option value="Králík">Králík</option>
            <option value="Morče">Morče</option>
            <option value="Jiné">Jiné</option>
        </select>
        <div id="jine-zvire-container"></div>
        <button onclick="pridatMazlicka()">Přidat</button>
    </div>

<div class="formular hidden" id="edit-user-form">
    <h2>Upravit uživatele <span class="zavrit" onclick="zavritEditUser()">×</span></h2>
    <label>Jméno: <input type="text" id="edit-user-jmeno" placeholder="Jméno" disabled></label>
    <label>E-mail: <input type="email" id="edit-user-email" placeholder="E-mail" disabled></label>
    <label>Telefon: <input type="text" id="edit-user-telefon" placeholder="Telefon" disabled></label>
    <label>Nové heslo: <input type="password" id="edit-user-heslo" placeholder="Nové heslo"></label>
    <button onclick="ulozitHeslo()">Změnit heslo</button>
    <label>Admin: <input type="checkbox" id="edit-user-admin"></label>
    <button onclick="ulozitAdminStav()">Uložit stav admina</button>
    <h3>Poznámky</h3>
    <div class="notes-list" id="edit-user-notes"></div>
    <textarea id="edit-user-poznamka" placeholder="Nová poznámka"></textarea>
    <button onclick="pridatPoznamkuAdmin()">Přidat poznámku</button>
    <h3>Rezervace uživatele</h3>
    <div class="reservations-list" id="edit-user-reservations"></div>
</div>

<script>
    let jePrihlasen = false;
    let jeAdmin = false;
    let userId = null;
    let token = null;
    let userPets = [];
    let vybranyTermin = null;
    let vybranyDen = new Date().toISOString().split('T')[0];

    document.addEventListener('DOMContentLoaded', () => {
        token = localStorage.getItem('token');
        if (token) {
            jePrihlasen = true;
            userId = localStorage.getItem('userId');
            jeAdmin = localStorage.getItem('isAdmin') === 'true';
            fetchUserData().then(() => {
                if (jeAdmin) zobrazitAdmin();
                else zobrazitZakaznici();
            });
        }
    });

    async function fetchUserData() {
        const response = await fetch('/profile', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        userPets = data.pets;
        return data;
    }

    function prihlasit() {
        const jmeno = document.getElementById('login-jmeno').value;
        const heslo = document.getElementById('login-heslo').value;
        fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jmeno, heslo })
        }).then(response => response.json()).then(data => {
            if (data.success) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('userId', data.userId);
                localStorage.setItem('isAdmin', data.isAdmin);
                token = data.token;
                jePrihlasen = true;
                userId = data.userId;
                jeAdmin = data.isAdmin;
                document.getElementById('prihlaseni-form').style.display = 'none';
                fetchUserData().then(() => {
                    if (jeAdmin) zobrazitAdmin();
                    else zobrazitZakaznici();
                });
            } else {
                alert(data.message);
            }
        });
    }

    function odhlasit() {
        localStorage.removeItem('token');
        localStorage.removeItem('userId');
        localStorage.removeItem('isAdmin');
        jePrihlasen = false;
        jeAdmin = false;
        userId = null;
        token = null;
        document.getElementById('zakaznici-sekce').classList.add('hidden');
        document.getElementById('admin-sekce').classList.add('hidden');
        document.getElementById('prihlaseni-btn').style.display = 'block';
        document.getElementById('odhlaseni-btn').classList.add('hidden');
        document.getElementById('pridat-mazlicka-btn').classList.add('hidden');
    }

    function registrace() {
        const jmeno = document.getElementById('reg-jmeno').value;
        const email = document.getElementById('reg-email').value;
        const telefon = document.getElementById('reg-telefon').value;
        const heslo = document.getElementById('reg-heslo').value;
        fetch('/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jmeno, email, telefon, heslo })
        }).then(response => response.json()).then(data => {
            if (data.success) {
                document.getElementById('registrace-form').style.display = 'none';
                alert('Registrace úspěšná, nyní se můžete přihlásit.');
            } else {
                alert(data.message);
            }
        });
    }

    function pridatMazlicka() {
        const name = document.getElementById('pet-name').value;
        const species = document.getElementById('pet-species').value;
        fetch('/profile/pets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ name, species })
        }).then(response => response.json()).then(data => {
            if (data.success) {
                document.getElementById('pridat-mazlicka-form').style.display = 'none';
                fetchUserData();
            } else {
                alert(data.error);
            }
        });
    }

    function zobrazitZakaznici() {
        document.getElementById('zakaznici-sekce').classList.remove('hidden');
        document.getElementById('admin-sekce').classList.add('hidden');
        document.getElementById('prihlaseni-btn').style.display = 'none';
        document.getElementById('odhlaseni-btn').classList.remove('hidden');
        document.getElementById('pridat-mazlicka-btn').classList.remove('hidden');
        aktualizovatZakaznici();
    }

    async function aktualizovatZakaznici() {
        const datum = document.getElementById('vyber-datum-zakaznici').value || vybranyDen;
        vybranyDen = datum;
        document.getElementById('datum-zakaznici').textContent = datum;
        const response = await fetch(`/reservations/${datum}`);
        const data = await response.json();
        const terminyDiv = document.getElementById('terminy-zakaznici');
        terminyDiv.innerHTML = '';
        data.forEach(termin => {
            const div = document.createElement('div');
            div.className = 'termin';
            div.classList.add(termin.approved ? 'obsazeny' : 'cekajici');
            if (termin.deleted) div.classList.add('smazany');
            div.innerHTML = `${termin.time} - ${termin.timeEnd || ''}<br>${termin.zakaznik}<br>${termin.duvod}<div class="podrobnosti">${termin.zvire ? `Mazlíček: ${termin.zvire}\n` : ''}${termin.telefon ? `Telefon: ${termin.telefon}\n` : ''}${termin.email ? `E-mail: ${termin.email}\n` : ''}${termin.note ? `Poznámka: ${termin.note}` : ''}</div>`;
            div.onclick = () => {
                vybranyTermin = termin;
                zobrazitEditaci();
            };
            terminyDiv.appendChild(div);
        });
        const volneHodiny = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00'];
        volneHodiny.forEach(hodina => {
            if (!data.some(t => t.time === hodina && !t.deleted)) {
                const div = document.createElement('div');
                div.className = 'termin volny';
                div.innerHTML = `${hodina}`;
                div.onclick = () => rezervovat(hodina);
                terminyDiv.appendChild(div);
            }
        });
    }

    function rezervovat(hodina) {
        if (!jePrihlasen) return alert("Musíte být přihlášeni!");
        document.getElementById('rezervace-form').style.display = 'block';
        document.getElementById('rezervace-cas').value = hodina;
        document.getElementById('rezervace-datum').value = vybranyDen;
    }

    function ulozitRezervaci() {
        const datum = document.getElementById('rezervace-datum').value;
        const time = document.getElementById('rezervace-cas').value;
        const timeEnd = document.getElementById('rezervace-cas-konec').value;
        const zakaznik = document.getElementById('rezervace-zakaznik').value;
        const zvire = document.getElementById('rezervace-zvire').value;
        const duvod = document.getElementById('rezervace-duvod').value;
        const telefon = document.getElementById('rezervace-telefon').value;
        const email = document.getElementById('rezervace-email').value;
        const note = document.getElementById('rezervace-poznamka').value;
        if (zakaznik && zvire && duvod) {
            fetch('/reservations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ date: datum, time, timeEnd, zakaznik, zvire, duvod, telefon, email, note })
            }).then(response => response.json()).then(data => {
                document.getElementById('rezervace-form').style.display = 'none';
                aktualizovatZakaznici();
            });
        } else {
            alert("Vyplňte povinné údaje!");
        }
    }

    async function zobrazitEditaci() {
        if (!jePrihlasen) return alert("Musíte být přihlášeni!");
        if (!jeAdmin && vybranyTermin.userId !== userId) return alert("Můžete upravit pouze své rezervace!");
        const userData = await fetchUserData();
        document.getElementById('editace-form').style.display = 'block';
        document.getElementById('edit-zakaznik').value = vybranyTermin.zakaznik;
        const zvireSelect = document.getElementById('edit-zvire');
        zvireSelect.innerHTML = '<option value="">Vyberte mazlíčka</option>';
        if (userPets.length > 0) {
            userPets.forEach(pet => {
                const option = document.createElement('option');
                option.value = pet.name;
                option.textContent = `${pet.name} (${pet.species})`;
                option.selected = pet.name === vybranyTermin.zvire;
                zvireSelect.appendChild(option);
            });
        } else if (!jeAdmin) {
            alert("Nemáte žádné mazlíčky. Nejprve přidejte mazlíčka.");
        }
        if (!jeAdmin) zvireSelect.setAttribute('required', '');
        else zvireSelect.removeAttribute('required');
        document.getElementById('edit-duvod').value = vybranyTermin.duvod;
        document.getElementById('edit-telefon').value = vybranyTermin.telefon || '';
        document.getElementById('edit-email').value = vybranyTermin.email || '';
        document.getElementById('edit-cas-zacatek').value = vybranyTermin.time;
        document.getElementById('edit-cas-konec').value = vybranyTermin.timeEnd || '';
        document.getElementById('edit-poznamka').value = vybranyTermin.note || '';
        
        // Interní poznámka – pouze pro admina
        const interniPoznamka = document.getElementById('edit-interni-poznamka');
        interniPoznamka.style.display = 'none'; // Skryto pro zákazníky
        if (jeAdmin) {
            interniPoznamka.style.display = 'block'; // Viditelné pro admina
            interniPoznamka.value = vybranyTermin.internalNote || '';
        }
        document.getElementById('schvalit-btn').classList.toggle('hidden', vybranyTermin.approved || !jeAdmin || vybranyTermin.deleted);
    }

    async function ulozitEditaci() {
        const zakaznik = document.getElementById('edit-zakaznik').value;
        const zvire = document.getElementById('edit-zvire').value || null;
        const duvod = document.getElementById('edit-duvod').value;
        const telefon = document.getElementById('edit-telefon').value;
        const email = document.getElementById('edit-email').value;
        const time = document.getElementById('edit-cas-zacatek').value;
        const timeEnd = document.getElementById('edit-cas-konec').value;
        const note = document.getElementById('edit-poznamka').value;
        const internalNote = jeAdmin ? document.getElementById('edit-interni-poznamka').value : vybranyTermin.internalNote; // Zákazník nemění internalNote

        if (zakaznik && duvod && (jeAdmin || zvire)) {
            const reservation = {
                time,
                timeEnd: timeEnd || null,
                zakaznik,
                zvire,
                duvod,
                telefon,
                email,
                note,
                internalNote: internalNote || null
            };
            const response = await fetch(`/reservations/${vybranyTermin.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(reservation)
            });
            if (response.ok) {
                document.getElementById('editace-form').style.display = 'none';
                if (jeAdmin) aktualizovatAdmin();
                else aktualizovatZakaznici();
            } else {
                alert("Nepodařilo se uložit změny.");
            }
        } else {
            alert("Vyplňte povinné údaje!");
        }
    }

    function smazatRezervaci() {
        fetch(`/reservations/${vybranyTermin.id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        }).then(response => response.json()).then(data => {
            document.getElementById('editace-form').style.display = 'none';
            if (jeAdmin) aktualizovatAdmin();
            else aktualizovatZakaznici();
        });
    }

    function schvalitRezervaci() {
        fetch(`/reservations/${vybranyTermin.id}/approve`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
        }).then(response => response.json()).then(data => {
            document.getElementById('editace-form').style.display = 'none';
            aktualizovatAdmin();
        });
    }

    function zobrazitAdmin() {
        document.getElementById('admin-sekce').classList.remove('hidden');
        document.getElementById('zakaznici-sekce').classList.add('hidden');
        document.getElementById('prihlaseni-btn').style.display = 'none';
        document.getElementById('odhlaseni-btn').classList.remove('hidden');
        document.getElementById('pridat-mazlicka-btn').classList.add('hidden');
        aktualizovatAdmin();
        aktualizovatMesic();
    }

    async function aktualizovatAdmin() {
        const datum = document.getElementById('vyber-datum-admin').value || vybranyDen;
        vybranyDen = datum;
        document.getElementById('datum-admin').textContent = datum;
        const response = await fetch(`/reservations/${datum}`);
        const data = await response.json();
        const terminyDiv = document.getElementById('terminy-admin');
        terminyDiv.innerHTML = '';
        data.forEach(termin => {
            const div = document.createElement('div');
            div.className = 'termin';
            div.classList.add(termin.approved ? 'obsazeny' : 'cekajici');
            if (termin.deleted) div.classList.add('smazany');
            div.innerHTML = `${termin.time} - ${termin.timeEnd || ''}<br>${termin.zakaznik}<br>${termin.duvod}<div class="podrobnosti">${termin.zvire ? `Mazlíček: ${termin.zvire}\n` : ''}${termin.telefon ? `Telefon: ${termin.telefon}\n` : ''}${termin.email ? `E-mail: ${termin.email}\n` : ''}${termin.note ? `Poznámka: ${termin.note}` : ''}${termin.internalNote ? `Interní poznámka: ${termin.internalNote}` : ''}</div>`;
            div.onclick = () => {
                vybranyTermin = termin;
                zobrazitEditaci();
            };
            terminyDiv.appendChild(div);
        });
    }

    function aktualizovatMesic() {
        const datum = new Date(vybranyDen);
        const prvniDen = new Date(datum.getFullYear(), datum.getMonth(), 1);
        const posledniDen = new Date(datum.getFullYear(), datum.getMonth() + 1, 0);
        const kalendar = document.getElementById('mesic-kalendar-admin');
        kalendar.innerHTML = '';
        for (let i = 0; i < prvniDen.getDay(); i++) {
            kalendar.innerHTML += '<div></div>';
        }
        for (let den = 1; den <= posledniDen.getDate(); den++) {
            const datumStr = `${prvniDen.getFullYear()}-${String(prvniDen.getMonth() + 1).padStart(2, '0')}-${String(den).padStart(2, '0')}`;
            const div = document.createElement('div');
            div.className = 'den';
            div.textContent = den;
            div.onclick = () => vybratDen(datumStr);
            fetch(`/reservations/${datumStr}`).then(response => response.json()).then(data => {
                if (data.length > 0) div.classList.add('obsazeny');
                else div.classList.add('volny');
            });
            kalendar.appendChild(div);
        }
    }

    function vybratDen(datum) {
        vybranyDen = datum;
        document.getElementById('vyber-datum-admin').value = datum;
        aktualizovatAdmin();
    }

    function predchoziMesic() {
        const datum = new Date(vybranyDen);
        datum.setMonth(datum.getMonth() - 1);
        vybranyDen = datum.toISOString().split('T')[0];
        aktualizovatMesic();
        aktualizovatAdmin();
    }

    function dalsiMesic() {
        const datum = new Date(vybranyDen);
        datum.setMonth(datum.getMonth() + 1);
        vybranyDen = datum.toISOString().split('T')[0];
        aktualizovatMesic();
        aktualizovatAdmin();
    }

    function hledatUzivatele() {
        const search = document.getElementById('search-users').value;
        fetch(`/users?search=${search}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        }).then(response => response.json()).then(data => {
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            data.forEach(user => {
                const div = document.createElement('div');
                div.className = 'user-item';
                div.innerHTML = `${user.username} (${user.email}) <button onclick="upravitUzivatele(${user.id})">Upravit</button>`;
                userList.appendChild(div);
            });
        });
    }

    async function upravitUzivatele(id) {
        const response = await fetch(`/users/${id}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const user = await response.json();
        document.getElementById('edit-user-form').style.display = 'block';
        document.getElementById('edit-user-jmeno').value = user.username;
        document.getElementById('edit-user-email').value = user.email;
        document.getElementById('edit-user-telefon').value = user.telefon;
        document.getElementById('edit-user-heslo').value = '';
        document.getElementById('edit-user-admin').checked = user.isAdmin;
        const notesDiv = document.getElementById('edit-user-notes');
        notesDiv.innerHTML = '';
        user.notes.forEach(note => {
            notesDiv.innerHTML += `<div class="note-item">${note.author}: ${note.text}</div>`;
        });
        const reservationsResponse = await fetch(`/users/${id}/reservations`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const reservations = await response.json();
        const reservationsDiv = document.getElementById('edit-user-reservations');
        reservationsDiv.innerHTML = '';
        reservations.forEach(res => {
            reservationsDiv.innerHTML += `<div class="reservation-item">${res.date} ${res.time} - ${res.zakaznik} (${res.duvod})</div>`;
        });
    }

    function zavritEditUser() {
        document.getElementById('edit-user-form').style.display = 'none';
    }

    function ulozitHeslo() {
        const heslo = document.getElementById('edit-user-heslo').value;
        const id = document.getElementById('edit-user-jmeno').value; // Předpokládáme, že username je unikátní
        fetch(`/users/${id}/password`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ password: heslo })
        }).then(response => response.json()).then(data => {
            if (data.success) {
                alert('Heslo změněno.');
            }
        });
    }

    function ulozitAdminStav() {
        const isAdmin = document.getElementById('edit-user-admin').checked;
        const id = document.getElementById('edit-user-jmeno').value;
        fetch(`/users/${id}/admin`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ isAdmin })
        }).then(response => response.json()).then(data => {
            if (data.success) {
                alert('Stav admina uložen.');
            }
        });
    }

    function pridatPoznamkuAdmin() {
        const note = document.getElementById('edit-user-poznamka').value;
        const id = document.getElementById('edit-user-jmeno').value;
        fetch(`/users/${id}/notes`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ note })
        }).then(response => response.json()).then(data => {
            if (data.success) {
                document.getElementById('edit-user-poznamka').value = '';
                upravitUzivatele(id);
            }
        });
    }
</script>
</body>
</html>
