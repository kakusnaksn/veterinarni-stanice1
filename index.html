<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veterinární ordinace</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; }
        .hlavicka { display: flex; justify-content: space-between; align-items: center; padding: 20px; background-color: #4CAF50; color: white; }
        .hlavicka h1 { margin: 0; }
        .hlavicka-buttons { display: flex; gap: 10px; }
        .prihlaseni-btn { padding: 10px 20px; width: 160px; background-color: #ffffff; color: #4CAF50; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; text-align: center; }
        .prihlaseni-btn:hover { background-color: #e0e0e0; }
        .sekce { max-width: 1000px; margin: 20px auto; padding: 20px; background-color: white; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .datum { text-align: center; font-size: 1.2em; margin-bottom: 20px; }
        .vyber-datum { text-align: center; margin-bottom: 20px; }
        .vyber-datum input[type="date"] { padding: 10px; font-size: 1em; border: 1px solid #ddd; border-radius: 5px; width: 360px; height: 40px; }
        .mesic-kalendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-bottom: 20px; }
        .den { padding: 10px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .den.volny { background-color: #4CAF50; color: white; }
        .den.obsazeny { background-color: #f44336; color: white; }
        .den:hover:not(.obsazeny) { background-color: #45a049; } 
        .terminy { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 20px; }
        .termin { padding: 15px; text-align: center; border-radius: 5px; cursor: pointer; }
        .volny { background-color: #4CAF50; color: white; }
        .obsazeny { background-color: #f44336; color: white; }
        .cekajici { background-color: #ff9800; color: white; }
        .smazany { background-color: #9e9e9e; color: white; }
        .volny:hover { background-color: #45a049; }
        .obsazeny:hover { background-color: #d32f2f; }
        .cekajici:hover { background-color: #e68a00; }
        .smazany:hover { background-color: #757575; }
        .podrobnosti { font-size: 0.9em; margin-top: 5px; }
        .mesic-ovladani { text-align: center; margin-bottom: 10px; }
        .mesic-ovladani button { padding: 8px 16px; margin: 0 5px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .mesic-ovladani button:hover { background-color: #45a049; }
        .formular { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.3); width: 400px; }
        .formular h3 { margin: 0 0 20px 0; text-align: center; }
        .formular .zavrit { position: absolute; right: 10px; top: 5px; font-size: 20px; cursor: pointer; color: #f44336; }
        .formular input, .formular select, .formular textarea { display: block; width: 360px; height: 40px; margin: 10px auto; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .formular textarea { height: 80px; }
        .formular button { display: block; width: 360px; height: 40px; margin: 10px auto; padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .formular .smazat-btn { background-color: #f44336; }
        .formular .schvalit-btn { background-color: #2196F3; }
        .formular button:hover { background-color: #45a049; }
        .formular .smazat-btn:hover { background-color: #d32f2f; }
        .formular .schvalit-btn:hover { background-color: #1976D2; }
        .hidden { display: none; }
        .search-bar { margin: 20px 0; text-align: center; }
        .search-bar input { width: 360px; height: 40px; padding: 10px; }
        .user-list, .notes-list, .reservations-list { margin-top: 20px; }
        .user-item, .note-item, .reservation-item { padding: 10px; border-bottom: 1px solid #ddd; }
        .pet-list { margin-top: 10px; }
        .pet-item { padding: 5px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 5px; }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #ff9800; color: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 1000; }
        .notification .zavrit { cursor: pointer; margin-left: 10px; font-size: 20px; }
        #zakaznik-search-results { position: absolute; background-color: white; border: 1px solid #ddd; width: 360px; max-height: 200px; overflow-y: auto; z-index: 10; }
        .zpet-btn { padding: 10px 20px; background-color: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; }
        .zpet-btn:hover { background-color: #1976D2; }
        .rezervace-list { margin-top: 20px; max-height: 300px; overflow-y: auto; }
        .rezervace-item { padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .rezervace-item button { padding: 5px 10px; background-color: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .rezervace-item button:hover { background-color: #e68900; }
        #home-sekce { text-align: center; }
        #home-sekce h2 { color: #4CAF50; }
        #home-sekce p { font-size: 1.1em; margin: 20px 0; }
        #home-sekce button { padding: 15px 30px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.2em; }
        #home-sekce button:hover { background-color: #45a049; }
    </style>
</head>
<body>
    <div class="hlavicka">
        <h1>Veterinární ordinace</h1>
        <div class="hlavicka-buttons">
            <button class="zpet-btn" id="zpet-btn" onclick="zobrazitHome()">Hlavní stránka</button>
            <button class="prihlaseni-btn hidden" id="prihlaseni-btn" onclick="zobrazitPrihlaseni()">Přihlášení</button>
            <button class="prihlaseni-btn hidden" id="registrace-btn" onclick="zobrazitRegistraci()">Registrace</button>
            <button class="prihlaseni-btn hidden" id="pridat-mazlicka-btn" onclick="zobrazitPridaniMazlicka()">Přidat mazlíčka</button>
            <button class="prihlaseni-btn hidden" id="odhlaseni-btn" onclick="odhlasit()">Odhlásit</button>
        </div>
    </div>

    <!-- Hlavní stránka -->
    <div class="sekce" id="home-sekce">
        <h2>Vítejte u nás!</h2>
        <p>Jsme veterinární ordinace, která se stará o zdraví vašich mazlíčků. Nabízíme profesionální péči a individuální přístup.</p>
        <button onclick="zobrazitRezervace()">Přejít na rezervace</button>
    </div>

    <!-- Rezervační systém -->
    <div class="sekce hidden" id="zakaznici-sekce">
        <div class="datum" id="datum-zakaznici"></div>
        <div class="vyber-datum">
            <input type="date" id="vyber-dne" onchange="zmenitDen(this.value)">
        </div>
        <div class="terminy" id="terminy-zakaznici"></div>
        <div id="moje-rezervace-sekce" class="hidden">
            <h2>Moje rezervace</h2>
            <div id="moje-rezervace-list" class="rezervace-list"></div>
        </div>
    </div>

    <div class="sekce hidden" id="admin-sekce">
        <div class="datum" id="datum-admin"></div>
        <div class="mesic-ovladani">
            <button onclick="predchoziMesic()">Předchozí měsíc</button>
            <button onclick="nasledujiciMesic()">Následující měsíc</button>
        </div>
        <div class="mesic-kalendar" id="mesic-kalendar-admin"></div>
        <div class="vyber-datum">
            <input type="date" id="vyber-dne-admin" onchange="zmenitDenAdmin(this.value)">
        </div>
        <div class="terminy" id="terminy-admin"></div>
        <div class="search-bar">
            <input type="text" id="search-users" placeholder="Hledat uživatele..." oninput="prohledatUzivatele()">
        </div>
        <div class="user-list" id="user-list"></div>
    </div>

    <!-- Formuláře -->
    <div class="formular" id="prihlaseni-form">
        <h3>Přihlášení <span class="zavrit" onclick="zavritPrihlaseni()">×</span></h3>
        <input type="text" id="jmeno" placeholder="Uživatelské jméno">
        <input type="password" id="heslo" placeholder="Heslo">
        <button onclick="prihlasit()">Přihlásit se</button>
    </div>

    <div class="formular" id="registrace-form">
        <h3>Registrace <span class="zavrit" onclick="zavritRegistraci()">×</span></h3>
        <input type="text" id="reg-jmeno" placeholder="Uživatelské jméno" required>
        <input type="email" id="reg-email" placeholder="E-mail" required>
        <input type="text" id="reg-telefon" placeholder="Telefon" required>
        <input type="password" id="reg-heslo" placeholder="Heslo" required>
        <button onclick="registrovat()">Registrovat se</button>
    </div>

    <div class="formular" id="rezervace-form-zakaznik">
        <h3>Nová rezervace <span class="zavrit" onclick="zavritRezervaci()">×</span></h3>
        <input type="text" id="zakaznik-zakaznik" placeholder="Jméno zákazníka" required disabled>
        <select id="zvire-zakaznik" class="zvire-select" required></select>
        <input type="text" id="duvod-zakaznik" placeholder="Důvod návštěvy" required>
        <input type="text" id="telefon-zakaznik" placeholder="Telefon (volitelné)">
        <input type="email" id="email-zakaznik" placeholder="E-mail (volitelné)">
        <textarea id="poznamka-zakaznik" placeholder="Poznámka k rezervaci"></textarea>
        <button onclick="ulozitRezervaciZakaznik()">Uložit</button>
    </div>

    <div class="formular" id="rezervace-form-admin">
        <h3>Nová rezervace <span class="zavrit" onclick="zavritRezervaciAdmin()">×</span></h3>
        <input type="text" id="zakaznik-search" placeholder="Hledat zákazníka..." oninput="hledatZakaznika()">
        <div id="zakaznik-search-results"></div>
        <input type="text" id="zakaznik-admin" placeholder="Jméno zákazníka" required>
        <select id="zvire-admin" class="zvire-select"></select>
        <input type="text" id="duvod-admin" placeholder="Důvod návštěvy" required>
        <input type="text" id="telefon-admin" placeholder="Telefon (volitelné)">
        <input type="email" id="email-admin" placeholder="E-mail (volitelné)">
        <textarea id="poznamka-admin" placeholder="Poznámka k rezervaci"></textarea>
        <textarea id="interni-poznamka-admin" placeholder="Interní poznámka (vidí jen admin)"></textarea>
        <button onclick="ulozitRezervaciAdmin()">Uložit</button>
    </div>

    <div class="formular" id="editace-form-zakaznik">
        <h3>Upravit rezervaci <span class="zavrit" onclick="zavritEditaci()">×</span></h3>
        <input type="text" id="edit-zakaznik-zakaznik" placeholder="Jméno zákazníka" required>
        <select id="edit-zvire-zakaznik" class="zvire-select" required></select>
        <input type="text" id="edit-duvod-zakaznik" placeholder="Důvod návštěvy" required>
        <input type="text" id="edit-telefon-zakaznik" placeholder="Telefon (volitelné)">
        <input type="email" id="edit-email-zakaznik" placeholder="E-mail (volitelné)">
        <select id="edit-cas-zacatek-zakaznik" required>
            <option value="8:00">8:00</option><option value="8:30">8:30</option><option value="9:00">9:00</option>
            <option value="9:30">9:30</option><option value="10:00">10:00</option><option value="10:30">10:30</option>
            <option value="11:00">11:00</option><option value="11:30">11:30</option><option value="13:00">13:00</option>
            <option value="13:30">13:30</option><option value="14:00">14:00</option><option value="14:30">14:30</option>
            <option value="15:00">15:00</option><option value="15:30">15:30</option>
        </select>
        <select id="edit-cas-konec-zakaznik">
            <option value="">Žádný konec</option>
            <option value="8:30">8:30</option><option value="9:00">9:00</option><option value="9:30">9:30</option>
            <option value="10:00">10:00</option><option value="10:30">10:30</option><option value="11:00">11:00</option>
            <option value="11:30">11:30</option><option value="13:00">13:00</option><option value="13:30">13:30</option>
            <option value="14:00">14:00</option><option value="14:30">14:30</option><option value="15:00">15:00</option>
            <option value="15:30">15:30</option><option value="16:00">16:00</option>
        </select>
        <textarea id="edit-poznamka-zakaznik" placeholder="Poznámka k rezervaci"></textarea>
        <button onclick="ulozitEditaci('zakaznik')">Uložit změny</button>
        <button class="smazat-btn" onclick="smazatRezervaci()">Smazat rezervaci</button>
    </div>

    <div class="formular" id="editace-form-admin">
        <h3>Upravit rezervaci <span class="zavrit" onclick="zavritEditaci()">×</span></h3>
        <input type="text" id="edit-zakaznik-admin" placeholder="Jméno zákazníka" required>
        <select id="edit-zvire-admin" class="zvire-select"></select>
        <input type="text" id="edit-duvod-admin" placeholder="Důvod návštěvy" required>
        <input type="text" id="edit-telefon-admin" placeholder="Telefon (volitelné)">
        <input type="email" id="edit-email-admin" placeholder="E-mail (volitelné)">
        <select id="edit-cas-zacatek-admin" required>
            <option value="8:00">8:00</option><option value="8:30">8:30</option><option value="9:00">9:00</option>
            <option value="9:30">9:30</option><option value="10:00">10:00</option><option value="10:30">10:30</option>
            <option value="11:00">11:00</option><option value="11:30">11:30</option><option value="13:00">13:00</option>
            <option value="13:30">13:30</option><option value="14:00">14:00</option><option value="14:30">14:30</option>
            <option value="15:00">15:00</option><option value="15:30">15:30</option>
        </select>
        <select id="edit-cas-konec-admin">
            <option value="">Žádný konec</option>
            <option value="8:30">8:30</option><option value="9:00">9:00</option><option value="9:30">9:30</option>
            <option value="10:00">10:00</option><option value="10:30">10:30</option><option value="11:00">11:00</option>
            <option value="11:30">11:30</option><option value="13:00">13:00</option><option value="13:30">13:30</option>
            <option value="14:00">14:00</option><option value="14:30">14:30</option><option value="15:00">15:00</option>
            <option value="15:30">15:30</option><option value="16:00">16:00</option>
        </select>
        <textarea id="edit-poznamka-admin" placeholder="Poznámka k rezervaci"></textarea>
        <textarea id="edit-interni-poznamka-admin" placeholder="Interní poznámka (vidí jen admin)"></textarea>
        <button onclick="ulozitEditaci('admin')">Uložit změny</button>
        <button class="smazat-btn" onclick="smazatRezervaci()">Smazat rezervaci</button>
        <button class="schvalit-btn hidden" id="schvalit-btn" onclick="schvalitRezervaci()">Schválit rezervaci</button>
    </div>

    <div class="formular" id="pridani-mazlicka-form">
        <h3>Přidat mazlíčka <span class="zavrit" onclick="zavritPridaniMazlicka()">×</span></h3>
        <input type="text" id="novy-mazlicek" placeholder="Jméno mazlíčka" required>
        <select id="druh-zvirete" onchange="zobrazitJine()" required>
            <option value="">Vyberte druh</option>
            <option value="Pes">Pes</option>
            <option value="Kočka">Kočka</option>
            <option value="Králík">Králík</option>
            <option value="Morče">Morče</option>
            <option value="Jiné">Jiné</option>
        </select>
        <div id="jine-zvire-container"></div>
        <button onclick="pridatMazlicka()">Přidat</button>
    </div>

    <div class="formular" id="edit-user-form">
        <h3>Upravit uživatele <span class="zavrit" onclick="zavritEditUser()">×</span></h3>
        <input type="text" id="edit-user-jmeno" placeholder="Jméno" disabled>
        <input type="email" id="edit-user-email" placeholder="E-mail" disabled>
        <input type="text" id="edit-user-telefon" placeholder="Telefon" disabled>
        <input type="password" id="edit-user-heslo" placeholder="Nové heslo">
        <div class="notes-list" id="edit-user-notes"></div>
        <textarea id="edit-user-poznamka" placeholder="Nová poznámka"></textarea>
        <button onclick="pridatPoznamkuAdmin()">Přidat poznámku</button>
        <button onclick="ulozitHeslo()">Změnit heslo</button>
        <div class="reservations-list" id="edit-user-reservations"></div>
    </div>

<script>
    let vybranyDen = new Date();
    let jePrihlasen = false;
    let jeAdmin = false;
    let token = null;
    let userId = null;
    let userPets = [];
    let vybranyZakaznikId = null;
    let vybranyTermin = null;
    const casy = ["8:00", "8:30", "9:00", "9:30", "10:00", "10:30", "11:00", "11:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30"];

    document.addEventListener('DOMContentLoaded', () => {
        token = localStorage.getItem('token');
        userId = localStorage.getItem('userId');
        jeAdmin = localStorage.getItem('isAdmin') === 'true';
        jePrihlasen = !!token;

        if (jePrihlasen) {
            fetchUserData().then(data => {
                userPets = data.pets || [];
                if (jeAdmin) {
                    zobrazitRezervace();
                    document.getElementById('admin-sekce').classList.remove('hidden');
                    aktualizovatAdmin();
                } else {
                    document.getElementById('pridat-mazlicka-btn').classList.remove('hidden');
                    document.getElementById('odhlaseni-btn').classList.remove('hidden');
                    zobrazitHome();
                }
            }).catch(error => {
                console.error('Chyba při načítání uživatelských dat:', error);
                odhlasit();
            });
        } else {
            zobrazitHome();
        }
    });

    function zobrazitHome() {
        document.getElementById('home-sekce').classList.remove('hidden');
        document.getElementById('zakaznici-sekce').classList.add('hidden');
        document.getElementById('admin-sekce').classList.add('hidden');
        document.getElementById('moje-rezervace-sekce').classList.add('hidden');
        document.getElementById('zpet-btn').classList.add('hidden');
        document.getElementById('prihlaseni-btn').classList.toggle('hidden', jePrihlasen);
        document.getElementById('registrace-btn').classList.toggle('hidden', jePrihlasen);
        document.getElementById('odhlaseni-btn').classList.toggle('hidden', !jePrihlasen);
        document.getElementById('pridat-mazlicka-btn').classList.toggle('hidden', !jePrihlasen || jeAdmin);
    }

    function zobrazitRezervace() {
        document.getElementById('home-sekce').classList.add('hidden');
        document.getElementById('zpet-btn').classList.remove('hidden');
        if (jeAdmin) {
            document.getElementById('admin-sekce').classList.remove('hidden');
            document.getElementById('zakaznici-sekce').classList.add('hidden');
            document.getElementById('moje-rezervace-sekce').classList.add('hidden');
            aktualizovatAdmin();
        } else {
            document.getElementById('zakaznici-sekce').classList.remove('hidden');
            document.getElementById('admin-sekce').classList.add('hidden');
            document.getElementById('moje-rezervace-sekce').classList.toggle('hidden', !jePrihlasen);
            aktualizovatZakaznici();
            if (jePrihlasen) zobrazitMojeRezervace();
        }
        document.getElementById('prihlaseni-btn').classList.toggle('hidden', jePrihlasen);
        document.getElementById('registrace-btn').classList.toggle('hidden', jePrihlasen);
        document.getElementById('odhlaseni-btn').classList.toggle('hidden', !jePrihlasen);
        document.getElementById('pridat-mazlicka-btn').classList.toggle('hidden', !jePrihlasen || jeAdmin);
    }

    async function fetchReservations(date) {
        try {
            const response = await fetch(`/reservations/${date}`, {
                headers: jePrihlasen ? { 'Authorization': `Bearer ${token}` } : {}
            });
            if (!response.ok) throw new Error('Nepodařilo se načíst rezervace');
            return await response.json();
        } catch (error) {
            console.error('Chyba při načítání rezervací:', error);
            return [];
        }
    }

    async function fetchUserData() {
        try {
            const response = await fetch('/profile', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                throw new Error(`Nepodařilo se načíst data uživatele: ${response.status}`);
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Chyba při načítání uživatelských dat:', error);
            throw error;
        }
    }

    async function fetchUsers(search = '') {
        try {
            const response = await fetch(`/users?search=${search}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Nepodařilo se načíst uživatele');
            return await response.json();
        } catch (error) {
            console.error('Chyba při načítání uživatelů:', error);
            return [];
        }
    }

    async function fetchUserReservations(userId) {
        try {
            const response = await fetch(`/users/${userId}/reservations`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Nepodařilo se načíst rezervace uživatele');
            return await response.json();
        } catch (error) {
            console.error('Chyba při načítání rezervací uživatele:', error);
            return [];
        }
    }

    async function fetchDeletedReservations() {
        try {
            const response = await fetch('/reservations/deleted', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Nepodařilo se načíst smazané rezervace');
            return await response.json();
        } catch (error) {
            console.error('Chyba při načítání smazaných rezervací:', error);
            return [];
        }
    }

    async function aktualizovatZakaznici() {
        const datumZakaznici = document.getElementById('datum-zakaznici');
        const vyberDne = document.getElementById('vyber-dne');
        vyberDne.value = vybranyDen.toISOString().split('T')[0];
        datumZakaznici.textContent = `Rezervace na ${vybranyDen.toLocaleDateString('cs-CZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
        document.getElementById('datum-admin').textContent = '';
        await aktualizovatTerminy('terminy-zakaznici', false);
    }

    async function aktualizovatAdmin() {
        const datumAdmin = document.getElementById('datum-admin');
        const vyberDneAdmin = document.getElementById('vyber-dne-admin');
        vyberDneAdmin.value = vybranyDen.toISOString().split('T')[0];
        datumAdmin.textContent = `Správa rezervací na ${vybranyDen.toLocaleDateString('cs-CZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
        document.getElementById('datum-zakaznici').textContent = '';
        await aktualizovatMesicKalendar();
        await aktualizovatTerminy('terminy-admin', true);
        await prohledatUzivatele();
        if (jeAdmin) await zobrazitNotifikaciSmazanych();
    }

    async function aktualizovatMesicKalendar() {
        const kalendar = document.getElementById('mesic-kalendar-admin');
        kalendar.innerHTML = '';
        const prvniDen = new Date(vybranyDen.getFullYear(), vybranyDen.getMonth(), 1);
        const posledniDen = new Date(vybranyDen.getFullYear(), vybranyDen.getMonth() + 1, 0);
        const startDen = prvniDen.getDay() || 7;

        for (let i = 1; i < startDen; i++) {
            const div = document.createElement('div');
            div.classList.add('den');
            kalendar.appendChild(div);
        }

        for (let i = 1; i <= posledniDen.getDate(); i++) {
            const den = new Date(vybranyDen.getFullYear(), vybranyDen.getMonth(), i);
            const denKey = den.toISOString().split('T')[0];
            const reservations = await fetchReservations(denKey);
            const div = document.createElement('div');
            div.classList.add('den');
            div.textContent = i;
            const maVolne = casy.some(cas => !reservations.some(r => r.time === cas && r.approved && !r.deleted));
            div.classList.add(maVolne ? 'volny' : 'obsazeny');
            div.addEventListener('click', () => {
                vybranyDen = den;
                aktualizovatAdmin();
            });
            kalendar.appendChild(div);
        }
    }

    async function aktualizovatTerminy(terminyId, editMode) {
        const terminyList = document.getElementById(terminyId);
        terminyList.innerHTML = ''; // Vymažeme předchozí obsah, aby se termíny nepřidávaly vícekrát
        const denKey = vybranyDen.toISOString().split('T')[0];
        const reservations = await fetchReservations(denKey);

        casy.forEach(cas => {
            const reservation = reservations.find(r => r.time === cas);
            const div = document.createElement('div');
            div.classList.add('termin');
            div.dataset.id = reservation ? reservation.id : null;
            div.textContent = reservation ? `${reservation.time}${reservation.timeEnd ? ` - ${reservation.timeEnd}` : ''}` : cas;

            if (!reservation) {
                div.classList.add('volny');
            } else if (reservation.deleted) {
                div.classList.add('smazany');
            } else if (!reservation.approved) {
                div.classList.add('cekajici');
            } else {
                div.classList.add('obsazeny');
            }

            if (reservation && (editMode || (jePrihlasen && reservation.userId === userId))) {
                const podrobnosti = document.createElement('div');
                podrobnosti.classList.add('podrobnosti');
                let text = `${reservation.zakaznik} (${reservation.zvire || 'Bez zvířete'}) - ${reservation.duvod}`;
                if (reservation.telefon) text += `\nTel: ${reservation.telefon}`;
                if (reservation.email) text += `\nEmail: ${reservation.email}`;
                if (reservation.note) text += `\nPoznámka: ${reservation.note}`;
                if (editMode && jeAdmin && reservation.internalNote) text += `\nInterní poznámka: ${reservation.internalNote}`;
                if (!reservation.approved) text += `\n(Čeká na schválení)`;
                if (reservation.deleted) text += `\n(Smazáno zákazníkem)`;
                podrobnosti.textContent = text;
                div.appendChild(podrobnosti);
            }

            div.addEventListener('click', async () => {
                if (!jePrihlasen) return alert("Musíte být přihlášeni k rezervaci nebo úpravě!");
                if (editMode && reservation) {
                    vybranyTermin = reservation;
                    zobrazitEditaci();
                } else if ((editMode || jePrihlasen) && !reservation) {
                    vybranyTermin = { date: denKey, time: cas };
                    jeAdmin ? zobrazitRezervaciAdmin() : zobrazitRezervaciZakaznik();
                }
            });

            terminyList.appendChild(div);
        });
    }

    async function prohledatUzivatele() {
        if (!jeAdmin) return;
        const search = document.getElementById('search-users').value;
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        const users = await fetchUsers(search);
        users.forEach(user => {
            const div = document.createElement('div');
            div.classList.add('user-item');
            div.innerHTML = `
                ${user.username} (${user.email}) 
                <button onclick="upravitUzivatele(${user.id})">Upravit</button>
                <button onclick="toggleAdmin(${user.id}, ${user.isAdmin})">${user.isAdmin ? 'Odebrat admina' : 'Přidat admina'}</button>
                <button onclick="smazatUzivatele(${user.id})">Smazat</button>
            `;
            userList.appendChild(div);
        });
    }

    async function toggleAdmin(userId, currentIsAdmin) {
        const potvrzeni = confirm(`Opravdu chcete ${currentIsAdmin ? 'odebrat' : 'přidat'} admin práva uživateli?`);
        if (potvrzeni) {
            try {
                const response = await fetch(`/users/${userId}/toggle-admin`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    alert('Role změněna.');
                    prohledatUzivatele();
                } else {
                    alert('Nepodařilo se změnit roli.');
                }
            } catch (error) {
                console.error('Chyba při změně role:', error);
                alert('Nastala chyba při změně role.');
            }
        }
    }

    async function smazatUzivatele(userId) {
        const potvrzeni = confirm('Opravdu chcete smazat tohoto uživatele a jeho rezervace?');
        if (potvrzeni) {
            try {
                const response = await fetch(`/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    alert('Uživatel smazán.');
                    prohledatUzivatele();
                } else {
                    alert('Nepodařilo se smazat uživatele.');
                }
            } catch (error) {
                console.error('Chyba při mazání uživatele:', error);
                alert('Nastala chyba při mazání uživatele.');
            }
        }
    }

    function predchoziMesic() {
        vybranyDen.setMonth(vybranyDen.getMonth() - 1);
        aktualizovatAdmin();
    }

    function nasledujiciMesic() {
        vybranyDen.setMonth(vybranyDen.getMonth() + 1);
        aktualizovatAdmin();
    }

    function zmenitDen(datum) {
        vybranyDen = new Date(datum);
        aktualizovatZakaznici();
    }

    function zmenitDenAdmin(datum) {
        vybranyDen = new Date(datum);
        aktualizovatAdmin();
    }

    function zobrazitPrihlaseni() {
        document.getElementById('prihlaseni-form').style.display = 'block';
    }

    function zavritPrihlaseni() {
        document.getElementById('prihlaseni-form').style.display = 'none';
    }

    function zobrazitRegistraci() {
        document.getElementById('registrace-form').style.display = 'block';
    }

    function zavritRegistraci() {
        document.getElementById('registrace-form').style.display = 'none';
    }

    async function prihlasit() {
        const jmeno = document.getElementById('jmeno').value;
        const heslo = document.getElementById('heslo').value;
        try {
            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ jmeno, heslo })
            });
            const result = await response.json();
            if (result.success) {
                token = result.token;
                jePrihlasen = true;
                userId = result.userId;
                jeAdmin = result.isAdmin;
                localStorage.setItem('token', token);
                localStorage.setItem('userId', userId);
                localStorage.setItem('isAdmin', jeAdmin);
                document.getElementById('prihlaseni-form').style.display = 'none';
                document.getElementById('prihlaseni-btn').classList.add('hidden');
                document.getElementById('registrace-btn').classList.add('hidden');
                document.getElementById('odhlaseni-btn').classList.remove('hidden');
                if (!jeAdmin) document.getElementById('pridat-mazlicka-btn').classList.remove('hidden');
                fetchUserData().then(data => {
                    userPets = data.pets || [];
                    zobrazitRezervace();
                }).catch(error => {
                    console.error('Chyba při načítání uživatelských dat po přihlášení:', error);
                    odhlasit();
                });
            } else {
                alert(result.message || "Špatné jméno nebo heslo!");
            }
        } catch (error) {
            console.error('Chyba při přihlášení:', error);
            alert('Nastala chyba při přihlášení.');
        }
    }

    async function registrovat() {
        const jmeno = document.getElementById('reg-jmeno').value;
        const email = document.getElementById('reg-email').value;
        const telefon = document.getElementById('reg-telefon').value;
        const heslo = document.getElementById('reg-heslo').value;
        if (jmeno && email && telefon && heslo) {
            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jmeno, email, telefon, heslo })
                });
                const result = await response.json();
                if (result.success) {
                    alert("Registrace úspěšná! Nyní se můžete přihlásit.");
                    zavritRegistraci();
                } else {
                    alert(result.message || "Registrace selhala.");
                }
            } catch (error) {
                console.error('Chyba při registraci:', error);
                alert('Nastala chyba při registraci.');
            }
        } else {
            alert("Vyplňte všechna pole!");
        }
    }

    function odhlasit() {
        jePrihlasen = false;
        jeAdmin = false;
        token = null;
        userId = null;
        userPets = [];
        vybranyZakaznikId = null;
        localStorage.clear();
        document.getElementById('pridat-mazlicka-btn').classList.add('hidden');
        document.getElementById('odhlaseni-btn').classList.add('hidden');
        document.getElementById('prihlaseni-btn').classList.remove('hidden');
        document.getElementById('registrace-btn').classList.remove('hidden');
        document.getElementById('moje-rezervace-sekce').classList.add('hidden');
        document.getElementById('moje-rezervace-list').innerHTML = '';
        document.getElementById('datum-zakaznici').textContent = '';
        document.getElementById('datum-admin').textContent = '';
        zobrazitHome();
    }

    async function zobrazitRezervaciZakaznik() {
        if (!jePrihlasen || jeAdmin) return alert("Musíte být přihlášeni jako zákazník!");
        try {
            const userData = await fetchUserData();
            document.getElementById('rezervace-form-zakaznik').style.display = 'block';
            document.getElementById('zakaznik-zakaznik').value = userData.username;
            document.getElementById('telefon-zakaznik').value = userData.telefon;
            document.getElementById('email-zakaznik').value = userData.email;
            const zvireSelect = document.getElementById('zvire-zakaznik');
            zvireSelect.innerHTML = '<option value="">Vyberte mazlíčka</option>';
            userPets.forEach(pet => {
                const option = document.createElement('option');
                option.value = pet.name;
                option.textContent = `${pet.name} (${pet.species})`;
                zvireSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Chyba při načítání dat pro rezervaci:', error);
            alert('Nastala chyba při načítání dat.');
        }
    }

    async function zobrazitRezervaciAdmin() {
        if (!jePrihlasen || !jeAdmin) return alert("Musíte být přihlášeni jako admin!");
        document.getElementById('rezervace-form-admin').style.display = 'block';
        document.getElementById('zakaznik-search').value = '';
        document.getElementById('zakaznik-admin').value = '';
        document.getElementById('telefon-admin').value = '';
        document.getElementById('email-admin').value = '';
        const zvireSelect = document.getElementById('zvire-admin');
        zvireSelect.innerHTML = '<option value="">Bez zvířete</option>';
        vybranyZakaznikId = null;
    }

    async function hledatZakaznika() {
        const search = document.getElementById('zakaznik-search').value;
        const resultsDiv = document.getElementById('zakaznik-search-results');
        resultsDiv.innerHTML = '';
        if (search.length < 2) return;

        const users = await fetchUsers(search);
        users.forEach(user => {
            const div = document.createElement('div');
            div.textContent = `${user.username} (${user.email})`;
            div.onclick = async () => {
                vybranyZakaznikId = user.id;
                document.getElementById('zakaznik-admin').value = user.username;
                document.getElementById('telefon-admin').value = user.telefon;
                document.getElementById('email-admin').value = user.email;
                const zvireSelect = document.getElementById('zvire-admin');
                zvireSelect.innerHTML = '<option value="">Bez zvířete</option>';
                try {
                    const response = await fetch(`/users/${user.id}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const userData = await response.json();
                    userData.pets.forEach(pet => {
                        const option = document.createElement('option');
                        option.value = pet.name;
                        option.textContent = `${pet.name} (${pet.species})`;
                        zvireSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Chyba při načítání mazlíčků:', error);
                }
                resultsDiv.innerHTML = '';
            };
            resultsDiv.appendChild(div);
        });
    }

    function zavritRezervaci() {
        document.getElementById('rezervace-form-zakaznik').style.display = 'none';
    }

    function zavritRezervaciAdmin() {
        document.getElementById('rezervace-form-admin').style.display = 'none';
    }

    async function ulozitRezervaciZakaznik() {
        const zakaznik = document.getElementById('zakaznik-zakaznik').value;
        const zvire = document.getElementById('zvire-zakaznik').value;
        const duvod = document.getElementById('duvod-zakaznik').value;
        const telefon = document.getElementById('telefon-zakaznik').value;
        const email = document.getElementById('email-zakaznik').value;
        const poznamka = document.getElementById('poznamka-zakaznik').value;

        if (!zakaznik || !zvire || !duvod) return alert("Vyplňte všechna povinná pole!");

        try {
            const response = await fetch('/reservations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    date: vybranyTermin.date,
                    time: vybranyTermin.time,
                    zakaznik,
                    zvire,
                    duvod,
                    telefon,
                    email,
                    note: poznamka
                })
            });
            if (response.ok) {
                alert("Rezervace uložena, čeká na schválení.");
                zavritRezervaci();
                aktualizovatZakaznici();
                zobrazitMojeRezervace();
            } else {
                const errorData = await response.json();
                alert(`Nepodařilo se uložit rezervaci: ${errorData.message || 'Není k dispozici podrobnější informace.'}`);
            }
        } catch (error) {
            console.error('Chyba při ukládání rezervace:', error);
            alert('Nastala chyba při ukládání rezervace.');
        }
    }

    async function ulozitRezervaciAdmin() {
        const zakaznik = document.getElementById('zakaznik-admin').value;
        const zvire = document.getElementById('zvire-admin').value;
        const duvod = document.getElementById('duvod-admin').value;
        const telefon = document.getElementById('telefon-admin').value;
        const email = document.getElementById('email-admin').value;
        const poznamka = document.getElementById('poznamka-admin').value;
        const interniPoznamka = document.getElementById('interni-poznamka-admin').value;

        if (!zakaznik || !duvod) return alert("Vyplňte všechna povinná pole!");

        try {
            const response = await fetch('/reservations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    date: vybranyTermin.date,
                    time: vybranyTermin.time,
                    zakaznik,
                    zvire,
                    duvod,
                    telefon,
                    email,
                    note: poznamka,
                    internalNote: interniPoznamka,
                    userId: vybranyZakaznikId,
                    approved: true
                })
            });
            if (response.ok) {
                alert("Rezervace uložena.");
                zavritRezervaciAdmin();
                aktualizovatAdmin();
            } else {
                const errorData = await response.json();
                alert(`Nepodařilo se uložit rezervaci: ${errorData.message || 'Není k dispozici podrobnější informace.'}`);
            }
        } catch (error) {
            console.error('Chyba při ukládání rezervace:', error);
            alert('Nastala chyba při ukládání rezervace.');
        }
    }

    async function zobrazitEditaci() {
        if (!vybranyTermin) return;
        const formId = jeAdmin ? 'editace-form-admin' : 'editace-form-zakaznik';
        const prefix = jeAdmin ? 'edit-' : 'edit-';
        const suffix = jeAdmin ? '-admin' : '-zakaznik';

        document.getElementById(formId).style.display = 'block';
        document.getElementById(`${prefix}zakaznik${suffix}`).value = vybranyTermin.zakaznik;
        document.getElementById(`${prefix}duvod${suffix}`).value = vybranyTermin.duvod;
        document.getElementById(`${prefix}telefon${suffix}`).value = vybranyTermin.telefon || '';
        document.getElementById(`${prefix}email${suffix}`).value = vybranyTermin.email || '';
        document.getElementById(`${prefix}poznamka${suffix}`).value = vybranyTermin.note || '';
        if (jeAdmin) document.getElementById('edit-interni-poznamka-admin').value = vybranyTermin.internalNote || '';
        document.getElementById(`${prefix}cas-zacatek${suffix}`).value = vybranyTermin.time;
        document.getElementById(`${prefix}cas-konec${suffix}`).value = vybranyTermin.timeEnd || '';

        const zvireSelect = document.getElementById(`${prefix}zvire${suffix}`);
        zvireSelect.innerHTML = jeAdmin ? '<option value="">Bez zvířete</option>' : '<option value="">Vyberte mazlíčka</option>';

        if (jeAdmin) {
            document.getElementById('schvalit-btn').classList.toggle('hidden', vybranyTermin.approved);
            try {
                const response = await fetch(`/users/${vybranyTermin.userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const userData = await response.json();
                userData.pets.forEach(pet => {
                    const option = document.createElement('option');
                    option.value = pet.name;
                    option.textContent = `${pet.name} (${pet.species})`;
                    if (pet.name === vybranyTermin.zvire) option.selected = true;
                    zvireSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Chyba při načítání mazlíčků:', error);
            }
        } else {
            userPets.forEach(pet => {
                const option = document.createElement('option');
                option.value = pet.name;
                option.textContent = `${pet.name} (${pet.species})`;
                if (pet.name === vybranyTermin.zvire) option.selected = true;
                zvireSelect.appendChild(option);
            });
        }
    }

    function zavritEditaci() {
        document.getElementById('editace-form-zakaznik').style.display = 'none';
        document.getElementById('editace-form-admin').style.display = 'none';
    }

    async function ulozitEditaci(mode) {
        const suffix = mode === 'admin' ? '-admin' : '-zakaznik';
        const zakaznik = document.getElementById(`edit-zakaznik${suffix}`).value;
        const zvire = document.getElementById(`edit-zvire${suffix}`).value;
        const duvod = document.getElementById(`edit-duvod${suffix}`).value;
        const telefon = document.getElementById(`edit-telefon${suffix}`).value;
        const email = document.getElementById(`edit-email${suffix}`).value;
        const casZacatek = document.getElementById(`edit-cas-zacatek${suffix}`).value;
        const casKonec = document.getElementById(`edit-cas-konec${suffix}`).value;
        const poznamka = document.getElementById(`edit-poznamka${suffix}`).value;
        const interniPoznamka = mode === 'admin' ? document.getElementById('edit-interni-poznamka-admin').value : '';

        if (!zakaznik || !duvod || (mode !== 'admin' && !zvire)) return alert("Vyplňte všechna povinná pole!");

        try {
            const response = await fetch(`/reservations/${vybranyTermin.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    date: vybranyTermin.date,
                    time: casZacatek,
                    timeEnd: casKonec,
                    zakaznik,
                    zvire,
                    duvod,
                    telefon,
                    email,
                    note: poznamka,
                    internalNote: interniPoznamka,
                    approved: mode === 'admin' ? vybranyTermin.approved : false
                })
            });
            if (response.ok) {
                alert("Rezervace upravena.");
                zavritEditaci();
                if (mode === 'admin') {
                    aktualizovatAdmin();
                } else {
                    aktualizovatZakaznici();
                    zobrazitMojeRezervace();
                }
            } else {
                const errorData = await response.json();
                alert(`Nepodařilo se upravit rezervaci: ${errorData.message || 'Není k dispozici podrobnější informace.'}`);
            }
        } catch (error) {
            console.error('Chyba při úpravě rezervace:', error);
            alert('Nastala chyba při úpravě rezervace.');
        }
    }

    async function smazatRezervaci() {
        const potvrzeni = confirm("Opravdu chcete smazat tuto rezervaci?");
        if (!potvrzeni) return;

        try {
            const response = await fetch(`/reservations/${vybranyTermin.id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                alert("Rezervace smazána.");
                zavritEditaci();
                if (jeAdmin) {
                    aktualizovatAdmin();
                } else {
                    aktualizovatZakaznici();
                    zobrazitMojeRezervace();
                }
            } else {
                const errorData = await response.json();
                alert(`Nepodařilo se smazat rezervaci: ${errorData.message || 'Není k dispozici podrobnější informace.'}`);
            }
        } catch (error) {
            console.error('Chyba při mazání rezervace:', error);
            alert('Nastala chyba při mazání rezervace.');
        }
    }

    async function schvalitRezervaci() {
        try {
            const response = await fetch(`/reservations/${vybranyTermin.id}/approve`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                alert("Rezervace schválena.");
                zavritEditaci();
                aktualizovatAdmin();
            } else {
                const errorData = await response.json();
                alert(`Nepodařilo se schválit rezervaci: ${errorData.message || 'Není k dispozici podrobnější informace.'}`);
            }
        } catch (error) {
            console.error('Chyba při schvalování rezervace:', error);
            alert('Nastala chyba při schvalování rezervace.');
        }
    }

    async function zobrazitMojeRezervace() {
        if (!jePrihlasen || jeAdmin) return;
        const list = document.getElementById('moje-rezervace-list');
        list.innerHTML = '';
        const reservations = await fetchUserReservations(userId);
        reservations.forEach(reservation => {
            const div = document.createElement('div');
            div.classList.add('rezervace-item');
            const date = new Date(reservation.date);
            div.innerHTML = `
                <span>${date.toLocaleDateString('cs-CZ')} ${reservation.time}${reservation.timeEnd ? ` - ${reservation.timeEnd}` : ''}: ${reservation.zvire} - ${reservation.duvod} (${reservation.approved ? 'Schváleno' : 'Čeká na schválení'})</span>
                <button onclick="upravitMojiRezervaci(${reservation.id})">Upravit</button>
            `;
            list.appendChild(div);
        });
    }

    async function upravitMojiRezervaci(reservationId) {
        const reservations = await fetchUserReservations(userId);
        vybranyTermin = reservations.find(r => r.id === reservationId);
        if (vybranyTermin) {
            zobrazitEditaci();
        }
    }

    function zobrazitPridaniMazlicka() {
        document.getElementById('pridani-mazlicka-form').style.display = 'block';
        document.getElementById('novy-mazlicek').value = '';
        document.getElementById('druh-zvirete').value = '';
        document.getElementById('jine-zvire-container').innerHTML = '';
    }

    function zavritPridaniMazlicka() {
        document.getElementById('pridani-mazlicka-form').style.display = 'none';
    }

    function zobrazitJine() {
        const druh = document.getElementById('druh-zvirete').value;
        const container = document.getElementById('jine-zvire-container');
        container.innerHTML = '';
        if (druh === 'Jiné') {
            const input = document.createElement('input');
            input.type = 'text';
            input.id = 'jine-zvire';
            input.placeholder = 'Zadejte druh zvířete';
            input.required = true;
            container.appendChild(input);
        }
    }

    async function pridatMazlicka() {
        const jmeno = document.getElementById('novy-mazlicek').value;
        let druh = document.getElementById('druh-zvirete').value;
        if (druh === 'Jiné') {
            druh = document.getElementById('jine-zvire').value;
        }

        if (!jmeno || !druh) return alert("Vyplňte všechna pole!");

        if (!token) {
            alert("Musíte být přihlášeni k přidání mazlíčka!");
            return;
        }

        try {
            console.log('Odesílám požadavek na /pets s tokenem:', token);
            const response = await fetch('/pets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ name: jmeno, species: druh })
            });

            if (response.ok) {
                alert("Mazlíček přidán.");
                zavritPridaniMazlicka();
                userPets.push({ name: jmeno, species: druh });
                // Aktualizujeme data uživatele
                fetchUserData().then(data => {
                    userPets = data.pets || [];
                });
            } else {
                const errorData = await response.json();
                console.error('Chyba při přidávání mazlíčka:', errorData);
                alert(`Nepodařilo se přidat mazlíčka: ${errorData.message || 'Není k dispozici podrobnější informace.'}`);
            }
        } catch (error) {
            console.error('Chyba při přidávání mazlíčka:', error);
            alert('Nastala chyba při přidávání mazlíčka.');
        }
    }

    async function upravitUzivatele(userId) {
        try {
            const response = await fetch(`/users/${userId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const user = await response.json();
            document.getElementById('edit-user-jmeno').value = user.username;
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-telefon').value = user.telefon;
            document.getElementById('edit-user-heslo').value = '';
            document.getElementById('edit-user-poznamka').value = '';

            const notesList = document.getElementById('edit-user-notes');
            notesList.innerHTML = '';
            user.notes.forEach(note => {
                const div = document.createElement('div');
                div.classList.add('note-item');
                div.textContent = note;
                notesList.appendChild(div);
            });

            const reservationsList = document.getElementById('edit-user-reservations');
            reservationsList.innerHTML = '';
            const reservations = await fetchUserReservations(userId);
            reservations.forEach(reservation => {
                const div = document.createElement('div');
                div.classList.add('reservation-item');
                const date = new Date(reservation.date);
                div.textContent = `${date.toLocaleDateString('cs-CZ')} ${reservation.time}${reservation.timeEnd ? ` - ${reservation.timeEnd}` : ''}: ${reservation.zvire} - ${reservation.duvod}`;
                reservationsList.appendChild(div);
            });

            document.getElementById('edit-user-form').style.display = 'block';
            vybranyZakaznikId = userId;
        } catch (error) {
            console.error('Chyba při načítání uživatele:', error);
            alert('Nastala chyba při načítání uživatele.');
        }
    }

    function zavritEditUser() {
        document.getElementById('edit-user-form').style.display = 'none';
    }

    async function pridatPoznamkuAdmin() {
        const poznamka = document.getElementById('edit-user-poznamka').value;
        if (!poznamka) return alert("Zadejte poznámku!");

        try {
            const response = await fetch(`/users/${vybranyZakaznikId}/notes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ note: poznamka })
            });
            if (response.ok) {
                alert("Poznámka přidána.");
                document.getElementById('edit-user-poznamka').value = '';
                upravitUzivatele(vybranyZakaznikId);
            } else {
                const errorData = await response.json();
                alert(`Nepodařilo se přidat poznámku: ${errorData.message || 'Není k dispozici podrobnější informace.'}`);
            }
        } catch (error) {
            console.error('Chyba při přidávání poznámky:', error);
            alert('Nastala chyba při přidávání poznámky.');
        }
    }

    async function ulozitHeslo() {
        const heslo = document.getElementById('edit-user-heslo').value;
        if (!heslo) return alert("Zadejte nové heslo!");

        try {
            const response = await fetch(`/users/${vybranyZakaznikId}/password`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ password: heslo })
            });
            if (response.ok) {
                alert("Heslo změněno.");
                document.getElementById('edit-user-heslo').value = '';
            } else {
                const errorData = await response.json();
                alert(`Nepodařilo se změnit heslo: ${errorData.message || 'Není k dispozici podrobnější informace.'}`);
            }
        } catch (error) {
            console.error('Chyba při změně hesla:', error);
            alert('Nastala chyba při změně hesla.');
        }
    }

    async function zobrazitNotifikaciSmazanych() {
        const deletedReservations = await fetchDeletedReservations();
        if (deletedReservations.length > 0) {
            const notification = document.createElement('div');
            notification.classList.add('notification');
            notification.innerHTML = `
                Máte ${deletedReservations.length} smazaných rezervací čekajících na potvrzení.
                <span class="zavrit" onclick="this.parentElement.remove()">×</span>
            `;
            document.body.appendChild(notification);
        }
    }
</script>
</body>
</html>
